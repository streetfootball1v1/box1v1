<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover"/>
<meta name="theme-color" content="#0a0a0a" id="theme-meta">
<title>BOX1V1 | –£–õ–ò–ß–ù–´–ô –§–£–¢–ë–û–õ 1 –ù–ê 1</title>

<!-- PWA -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIkJPWDFWMSIsICJzaG9ydF9uYW1lIjogIkJPWDFWMSIsICJzdGFydF91cmwiOiAiLyIsICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLCAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmFmYWZhIiwgInRoZW1lX2NvbG9yIjogIiMwYTBhMGEifQ==">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
  --bg: #fafafa;
  --bg-elevated: rgba(255, 255, 255, 0.8);
  --bg-card: #ffffff;
  --text: #0a0a0a;
  --text-secondary: #374151;
  --text-tertiary: #6b7280;
  --accent: #16a34a;
  --accent-gk: #f59e0b;
  --accent-field: #16a34a;
  --border: rgba(0,0,0,0.08);
  --border-strong: rgba(0,0,0,0.15);
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --nav-h: 72px;
  --radius: 24px;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
  --ease-out: cubic-bezier(0.2, 0, 0, 1);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --shadow: 0 4px 20px rgba(0,0,0,0.05);
}

[data-theme="dark"] {
  --bg: #0a0a0a;
  --bg-elevated: rgba(255, 255, 255, 0.05);
  --bg-card: #1a1a1a;
  --text: #fafafa;
  --text-secondary: #9ca3af;
  --text-tertiary: #6b7280;
  --border: rgba(255,255,255,0.1);
  --border-strong: rgba(255,255,255,0.2);
  --shadow: 0 4px 20px rgba(0,0,0,0.5);
}

@media (max-width: 420px) { :root { --nav-h: 64px; } }

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

@media (prefers-reduced-motion: reduce) {
  html { scroll-behavior: auto; }
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

html { scroll-behavior: smooth; background: var(--bg); -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }

body { 
  font-family: var(--font-sans); 
  background: var(--bg); 
  color: var(--text); 
  line-height: 1.6; 
  overflow-x: hidden; 
  min-height: 100vh; 
  min-height: 100dvh; 
  transition: background 0.3s, color 0.3s;
}

h1, h2, h3 { 
  font-weight: 900; 
  font-style: italic; 
  letter-spacing: -0.03em; 
  line-height: 1.15; 
  text-transform: uppercase; 
}

.skip-link { 
  position: absolute; 
  top: -40px; 
  left: 0; 
  background: var(--text); 
  color: var(--bg); 
  padding: 8px; 
  text-decoration: none; 
  z-index: 10000; 
  transition: top 0.3s; 
}
.skip-link:focus { top: 0; }

/* PULL TO REFRESH */
.ptr-indicator {
  position: fixed;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 40px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
  transition: top 0.2s, transform 0.2s;
  box-shadow: var(--shadow);
  pointer-events: none;
}
.ptr-indicator.visible { top: calc(var(--nav-h) + 20px); }
.ptr-indicator.refreshing { animation: rotate 1s linear infinite; }
@keyframes rotate { to { transform: translateX(-50%) rotate(360deg); } }

/* PRELOADER */
#preloader { 
  position: fixed; 
  inset: 0; 
  background: var(--bg); 
  z-index: 9999; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  transition: opacity 0.6s var(--ease-out), visibility 0.6s; 
}
#preloader.loaded { 
  opacity: 0; 
  visibility: hidden; 
  pointer-events: none; 
}
.preloader-content { text-align: center; padding: 20px; }
.preloader-logo { 
  font-size: clamp(2rem, 8vw, 3rem); 
  font-weight: 900; 
  font-style: italic; 
  letter-spacing: -0.05em; 
  margin-bottom: 1.5rem; 
  animation: pulse 2s infinite; 
  color: var(--text);
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.loading-bar { 
  width: 160px; 
  height: 3px; 
  background: var(--border); 
  border-radius: 3px; 
  overflow: hidden; 
  margin: 0 auto; 
  position: relative; 
}
.loading-bar::after { 
  content: ''; 
  position: absolute; 
  left: -50%; 
  width: 50%; 
  height: 100%; 
  background: var(--text); 
  animation: load 1.2s infinite ease-in-out; 
  border-radius: 3px; 
}
@keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

/* SKELETON */
.skeleton {
  background: linear-gradient(90deg, var(--border) 25%, var(--bg-elevated) 50%, var(--border) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 12px;
}
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* TOASTS */
#toast-container { 
  position: fixed; 
  bottom: max(24px, calc(var(--safe-bottom) + 8px)); 
  left: 50%; 
  transform: translateX(-50%); 
  z-index: 10001; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
  pointer-events: none; 
  width: calc(100% - 40px); 
  max-width: 400px; 
}
.toast { 
  background: rgba(0,0,0,0.9); 
  backdrop-filter: blur(12px); 
  color: #fff; 
  padding: 16px 24px; 
  border-radius: 100px; 
  font-size: 14px; 
  font-weight: 600; 
  box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
  animation: toastIn 0.4s var(--ease-spring) forwards; 
  pointer-events: auto; 
  text-align: center; 
}
@keyframes toastIn { 
  from { opacity: 0; transform: translateY(20px) scale(0.9); } 
  to { opacity: 1; transform: translateY(0) scale(1); } 
}

/* LIVE REGION */
.live-region { position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden; }

/* NAVIGATION */
nav { 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: calc(var(--nav-h) + var(--safe-top)); 
  padding-top: var(--safe-top); 
  background: rgba(var(--bg-rgb, 250,250,250), 0.95); 
  backdrop-filter: blur(20px); 
  -webkit-backdrop-filter: blur(20px); 
  z-index: 1000; 
  border-bottom: 1px solid var(--border); 
  transition: box-shadow 0.3s, background 0.3s; 
}
nav.scrolled { box-shadow: var(--shadow); }
[data-theme="dark"] nav { background: rgba(10,10,10,0.95); }

.nav-inner { 
  max-width: 1300px; 
  margin: 0 auto; 
  height: var(--nav-h); 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  padding: 0 max(20px, var(--safe-left)) 0 max(20px, var(--safe-right)); 
}

.logo { 
  font-size: 1.5rem; 
  font-weight: 900; 
  font-style: italic; 
  letter-spacing: -0.03em; 
  cursor: pointer; 
  transition: opacity 0.2s; 
  text-decoration: none; 
  color: var(--text); 
  padding: 8px 0; 
}
.logo:hover { opacity: 0.7; }
.logo-accent { color: var(--accent); }

.nav-links { display: flex; gap: 8px; align-items: center; }
.nav-links a { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  text-decoration: none; 
  font-size: 12px; 
  font-weight: 700; 
  letter-spacing: 0.05em; 
  text-transform: uppercase; 
  color: var(--text-secondary); 
  padding: 10px 20px; 
  border-radius: 100px; 
  transition: all 0.2s; 
  min-height: 44px; 
  border: 1px solid transparent; 
}
.nav-links a:hover, .nav-links a:focus { 
  color: var(--text); 
  background: var(--bg-elevated); 
}
.nav-links a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
.nav-links a.active { 
  background: var(--text); 
  color: var(--bg); 
  border-color: var(--text); 
}

/* THEME TOGGLE */
.theme-toggle {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text);
  margin-left: 8px;
}
.theme-toggle:hover { background: var(--border); }

/* BURGER */
.burger { 
  display: none; 
  cursor: pointer; 
  width: 44px; 
  height: 44px; 
  flex-direction: column; 
  justify-content: center; 
  align-items: center; 
  gap: 5px; 
  border-radius: 12px; 
  background: var(--bg-elevated); 
  border: none; 
  transition: all 0.3s; 
}
.burger:hover { background: var(--border); }
.burger:active { transform: scale(0.95); }
.burger span { 
  width: 20px; 
  height: 2px; 
  background: var(--text); 
  border-radius: 2px; 
  transition: all 0.3s; 
}
.burger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
.burger.open span:nth-child(2) { opacity: 0; }
.burger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

/* MOBILE MENU */
.drawer-overlay { 
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,0.4); 
  z-index: 1999; 
  opacity: 0; 
  visibility: hidden; 
  transition: all 0.3s; 
}
.drawer-overlay.open { opacity: 1; visibility: visible; }

.mobile-drawer { 
  position: fixed; 
  left: 0; 
  right: 0; 
  bottom: -100%; 
  max-height: 70vh; 
  background: var(--bg-card); 
  backdrop-filter: blur(20px); 
  z-index: 2000; 
  padding: 20px 24px calc(24px + var(--safe-bottom)); 
  border-radius: 24px 24px 0 0; 
  transition: bottom 0.4s var(--ease-spring); 
  box-shadow: 0 -10px 40px rgba(0,0,0,0.15); 
}
.mobile-drawer.open { bottom: 0; }
.mobile-drawer::before {
  content: '';
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 4px;
  background: var(--border-strong);
  border-radius: 2px;
}
.mobile-drawer a { 
  display: block;
  font-size: 1.25rem; 
  font-weight: 700; 
  text-decoration: none; 
  color: var(--text); 
  padding: 16px 0; 
  border-bottom: 1px solid var(--border); 
  text-align: center; 
  transition: color 0.2s; 
}
.mobile-drawer a:last-of-type { border-bottom: none; }
.mobile-drawer a:hover, .mobile-drawer a:focus { color: var(--accent); }
.mobile-drawer .btn-group { 
  margin-top: 24px; 
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* MAIN */
.main-content { 
  max-width: 1300px; 
  margin: 0 auto; 
  padding: calc(var(--nav-h) + var(--safe-top) + 20px) max(20px, var(--safe-left)) calc(100px + var(--safe-bottom)) max(20px, var(--safe-right)); 
  min-height: 100vh; 
  min-height: 100dvh; 
}

section { display: none; opacity: 0; animation: fadeIn 0.6s var(--ease-out) forwards; }
section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* INTRO */
.intro-block { padding: 60px 0 80px; text-align: center; max-width: 900px; margin: 0 auto; }
.intro-block span { 
  display: block; 
  font-size: 12px; 
  font-weight: 800; 
  text-transform: uppercase; 
  letter-spacing: 0.2em; 
  color: var(--accent); 
  margin-bottom: 20px; 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.2s forwards; 
}
.intro-block h1 { 
  font-size: clamp(2.5rem, 10vw, 6rem); 
  margin-bottom: 20px; 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.3s forwards; 
  line-height: 1.1; 
  color: var(--text);
}
.intro-block p { 
  font-size: clamp(1rem, 2.5vw, 1.25rem); 
  color: var(--text-secondary); 
  max-width: 500px; 
  margin: 0 auto 32px; 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.4s forwards; 
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

.btn-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; opacity: 0; animation: fadeInUp 0.6s 0.5s forwards; }

/* BUTTONS */
.btn { 
  padding: 16px 28px; 
  border-radius: 100px; 
  font-weight: 700; 
  text-transform: uppercase; 
  font-size: 13px; 
  letter-spacing: 0.03em; 
  cursor: pointer; 
  transition: all 0.25s var(--ease-out); 
  border: none; 
  text-decoration: none; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px; 
  min-height: 52px; 
  min-width: 140px; 
  background: var(--text); 
  color: var(--bg); 
  position: relative;
  overflow: hidden;
}
.btn:hover, .btn:focus { 
  transform: translateY(-2px); 
  box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
}
.btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 3px; }
.btn-outline { 
  background: transparent; 
  border: 1.5px solid var(--border-strong); 
  color: var(--text); 
}
.btn-outline:hover, .btn-outline:focus { 
  background: var(--bg-elevated); 
  border-color: var(--text); 
}
.btn.accent { background: var(--accent); color: white; }
.btn.accent-gk { background: var(--accent-gk); color: white; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

@media (hover: none) and (pointer: coarse) {
  .btn:hover { transform: none !important; }
  .btn:active { transform: scale(0.96); opacity: 0.9; }
}

/* COMPARE BAR */
.compare-bar {
  position: fixed;
  bottom: -100px;
  left: 0;
  right: 0;
  background: var(--bg-card);
  border-top: 1px solid var(--border);
  padding: 16px 24px calc(16px + var(--safe-bottom));
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 998;
  transition: bottom 0.3s var(--ease-spring);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
}
.compare-bar.visible { bottom: 0; }
.compare-count { font-weight: 700; font-size: 14px; }
.compare-actions { display: flex; gap: 8px; }

/* TIMER */
.timer-context { 
  margin-top: 48px; 
  padding: 20px 32px; 
  background: var(--bg-elevated); 
  backdrop-filter: blur(10px); 
  border-radius: 20px; 
  display: inline-flex; 
  align-items: center; 
  gap: 24px; 
  border: 1px solid var(--border); 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.6s forwards; 
  flex-wrap: wrap; 
  justify-content: center; 
}
.timer-label { 
  font-size: 12px; 
  font-weight: 700; 
  color: var(--text-secondary); 
  text-transform: uppercase; 
  letter-spacing: 0.1em; 
}
.countdown { display: flex; gap: 16px; }
.countdown > div { text-align: center; min-width: 48px; }
.countdown-value { 
  font-size: clamp(1.5rem, 4vw, 2rem); 
  font-weight: 900; 
  line-height: 1; 
  font-variant-numeric: tabular-nums; 
  color: var(--text);
}
.countdown-label { 
  font-size: 10px; 
  font-weight: 700; 
  color: var(--text-tertiary); 
  text-transform: uppercase; 
  margin-top: 4px; 
}

/* BENTO GRID */
.bento-grid { 
  display: grid; 
  grid-template-columns: repeat(4, 1fr); 
  gap: 20px; 
  margin-top: 40px; 
}
@media (max-width: 1024px) { .bento-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 768px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 480px) { .bento-grid { grid-template-columns: 1fr; } }

.card { 
  background: var(--bg-elevated); 
  backdrop-filter: blur(10px); 
  border-radius: var(--radius); 
  border: 1px solid var(--border); 
  padding: 28px; 
  position: relative; 
  overflow: hidden; 
  transition: all 0.3s var(--ease-out); 
  cursor: pointer; 
  display: flex; 
  flex-direction: column; 
  gap: 12px; 
  transform-style: preserve-3d;
  perspective: 1000px;
}
@media (hover: hover) { 
  .card:hover { 
    transform: translateY(-4px); 
    border-color: var(--border-strong); 
    box-shadow: var(--shadow); 
  } 
}
.card:active { transform: scale(0.98); }
.card:focus-visible { outline: 2px solid var(--accent); outline-offset: 4px; }
.card h2 { font-size: clamp(1.5rem, 3vw, 2rem); line-height: 1.1; color: var(--text); }
.card h3 { font-size: 1.25rem; line-height: 1.2; color: var(--text); }
.card p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }
.card.span-2 { grid-column: span 2; }
@media (max-width: 768px) { .card.span-2 { grid-column: 1 / -1; } }

/* 3D TILT EFFECT */
.tilt-inner {
  transform-style: preserve-3d;
  transition: transform 0.1s;
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* PLAYER CARDS */
.player-card { 
  min-height: 380px; 
  background: linear-gradient(180deg, #2a2a2a 0%, #000 100%); 
  color: #fff; 
  border: none; 
  padding: 0; 
  position: relative; 
  border-radius: var(--radius); 
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.player-img { 
  position: absolute; 
  inset: 0; 
  background-size: cover; 
  background-position: center top; 
  background-repeat: no-repeat;
  opacity: 0;
  transition: opacity 0.5s, transform 0.5s; 
  z-index: 0;
}
.player-img.loaded { opacity: 1; }
.player-img.error { 
  background: linear-gradient(135deg, #444 0%, #222 100%); 
  opacity: 0.4; 
}
@media (hover: hover) { 
  .player-card:hover .player-img.loaded { 
    transform: scale(1.03); 
  } 
}

/* Gradient overlay - improved visibility */
.player-card::after { 
  content: ''; 
  position: absolute; 
  bottom: 0;
  left: 0;
  right: 0;
  height: 80%;
  background: linear-gradient(to top, rgba(0,0,0,0.98) 0%, rgba(0,0,0,0.8) 30%, rgba(0,0,0,0.4) 60%, transparent 100%); 
  z-index: 1;
  pointer-events: none; 
}

.player-info { 
  position: relative; 
  z-index: 2; 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 6px; 
  padding: 24px;
  transform: translateZ(20px);
}

.player-info h3 { 
  font-size: clamp(1.2rem, 3vw, 1.6rem); 
  line-height: 1.25; 
  margin: 0;
  overflow-wrap: break-word;
  word-wrap: break-word;
  hyphens: auto;
  max-width: 100%;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #fff;
}

.player-info span { 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--accent); 
  letter-spacing: 0.1em; 
}
.player-info span.gk { color: var(--accent-gk); }
.player-badges { 
  font-size: 11px; 
  color: rgba(255,255,255,0.6); 
  font-weight: 500;
}

.ovr-badge { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  padding: 6px 14px; 
  background: var(--accent); 
  color: #fff; 
  border-radius: 100px; 
  font-weight: 800; 
  font-size: 13px; 
  margin-top: 12px; 
  width: fit-content; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  position: relative;
  z-index: 10;
}
.ovr-badge.gk { background: var(--accent-gk); }

.status-badge {
  position: absolute; 
  top: 16px; 
  right: 16px; 
  z-index: 5; 
  background: var(--accent); 
  color: #fff; 
  font-size: 10px; 
  font-weight: 700; 
  padding: 4px 10px; 
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.status-badge.gk { background: var(--accent-gk); }

/* Compare checkbox on cards */
.compare-checkbox {
  position: absolute;
  top: 16px;
  left: 16px;
  z-index: 10;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.5);
  background: rgba(0,0,0,0.3);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  color: transparent;
}
.compare-checkbox:hover { border-color: #fff; background: rgba(0,0,0,0.5); }
.compare-checkbox.checked { 
  background: var(--accent); 
  border-color: var(--accent); 
  color: #fff; 
}

/* TABLE & MOBILE CARDS */
.table-wrapper { 
  background: var(--bg-elevated); 
  backdrop-filter: blur(10px); 
  border-radius: var(--radius); 
  border: 1px solid var(--border); 
  overflow: hidden; 
  overflow-x: auto; 
  -webkit-overflow-scrolling: touch; 
}

/* Mobile Cards View (hidden on desktop) */
.mobile-stats-grid {
  display: none;
  gap: 16px;
}
.mobile-player-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  transition: all 0.2s;
}
.mobile-player-card:active { transform: scale(0.98); }
.mobile-player-card .rank {
  font-size: 20px;
  font-weight: 900;
  font-style: italic;
  color: var(--text-tertiary);
  min-width: 40px;
  text-align: center;
}
.mobile-player-card .avatar {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  object-fit: cover;
  background: var(--bg-elevated);
}
.mobile-player-card .info { flex: 1; min-width: 0; }
.mobile-player-card .name {
  font-weight: 700;
  text-transform: uppercase;
  font-style: italic;
  font-size: 16px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}
.mobile-player-card .role {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.mobile-player-card .ovr {
  font-size: 24px;
  font-weight: 900;
  font-style: italic;
  color: var(--accent);
}

@media (max-width: 640px) {
  .table-wrapper { display: none; }
  .mobile-stats-grid { display: grid; }
}

table { width: 100%; border-collapse: collapse; min-width: 400px; }
th { 
  text-align: left; 
  padding: 20px 24px; 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--text-tertiary); 
  letter-spacing: 0.05em; 
  border-bottom: 1px solid var(--border); 
  white-space: nowrap; 
}
td { padding: 16px 24px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text); }
tr:last-child td { border-bottom: none; }
tbody tr { cursor: pointer; transition: background 0.2s; }
tbody tr:hover, tbody tr:focus-within { background: var(--bg-elevated); }
tbody tr:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }

.player-row { display: flex; align-items: center; gap: 12px; }
.player-avatar-sm { 
  width: 40px; 
  height: 40px; 
  border-radius: 12px; 
  object-fit: cover; 
  background: var(--bg-elevated); 
  flex-shrink: 0; 
}
.player-info-sm { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.player-name-sm { 
  font-weight: 700; 
  text-transform: uppercase; 
  font-style: italic; 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  font-size: 0.95rem;
  color: var(--text);
}
.player-role-sm { 
  font-size: 11px; 
  font-weight: 600; 
  color: var(--text-secondary); 
  text-transform: uppercase; 
  letter-spacing: 0.05em; 
}

/* MODAL */
.modal-overlay { 
  position: fixed; 
  inset: 0; 
  background: rgba(var(--bg-rgb, 250,250,250), 0.95); 
  backdrop-filter: blur(20px); 
  z-index: 3000; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  padding: 20px; 
  opacity: 0; 
  visibility: hidden; 
  transition: all 0.3s; 
}
[data-theme="dark"] .modal-overlay { background: rgba(10,10,10,0.95); }
.modal-overlay.active { opacity: 1; visibility: visible; }

.modal-content { 
  background: var(--bg-card); 
  width: 100%; 
  max-width: 480px; 
  border-radius: 24px; 
  padding: 32px; 
  position: relative; 
  max-height: 90vh; 
  max-height: 90dvh; 
  overflow-y: auto; 
  box-shadow: var(--shadow); 
  border: 1px solid var(--border); 
  transform: translateY(20px); 
  transition: transform 0.3s var(--ease-spring); 
  color: var(--text);
}
.modal-overlay.active .modal-content { transform: translateY(0); }

/* Compare Modal - wider */
.modal-content.wide {
  max-width: 900px;
}

.modal-header-fixed { 
  position: sticky; 
  top: -32px;
  right: 0; 
  left: 0;
  display: flex; 
  justify-content: flex-end;
  gap: 8px; 
  z-index: 10; 
  margin: -32px -32px 16px -32px;
  padding: 16px 20px;
  background: linear-gradient(to bottom, var(--bg-card), transparent);
  pointer-events: none;
}
.modal-header-fixed > button { pointer-events: auto; }

@media (max-width: 640px) {
  .modal-header-fixed {
    position: static;
    margin: 0 0 16px 0;
    padding: 0;
    background: none;
    justify-content: flex-end;
  }
  .modal-content { padding: 24px; max-height: 100vh; border-radius: 0; }
  .modal-content.wide { max-width: 100%; }
}

.modal-close, .download-circle { 
  width: 40px; 
  height: 40px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  border: 1px solid var(--border); 
  transition: all 0.2s; 
  background: var(--bg-card); 
  color: var(--text-secondary); 
}
.modal-close:hover, .download-circle:hover, .modal-close:focus, .download-circle:focus { 
  background: var(--bg-elevated); 
  color: var(--text); 
  border-color: var(--border-strong); 
}

#m-img-container, .compare-img-container { 
  width: 100%; 
  aspect-ratio: 1 / 1; 
  max-height: 280px; 
  border-radius: 16px; 
  overflow: hidden; 
  background: var(--bg-elevated);
  margin-bottom: 24px; 
  position: relative; 
}
.compare-img-container { max-height: 200px; }
#m-img, .compare-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
#m-img.loaded, .compare-img.loaded { opacity: 1; }

.modal-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
  gap: 16px; 
  margin-bottom: 24px; 
  word-break: break-word;
}
.modal-title-group { flex: 1; min-width: 0; }
#m-role { 
  display: inline-block; 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--accent); 
  background: rgba(22,163,74,0.1); 
  padding: 6px 12px; 
  border-radius: 20px; 
  margin-bottom: 8px; 
  letter-spacing: 0.05em; 
}
#m-role.gk { color: var(--accent-gk); background: rgba(245,158,11,0.1); }
#m-name { 
  font-size: clamp(1.5rem, 4vw, 2rem); 
  line-height: 1.2; 
  color: var(--text);
}
#m-badges { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
.badge { 
  font-size: 10px; 
  font-weight: 700; 
  background: var(--text); 
  color: var(--bg); 
  padding: 4px 10px; 
  border-radius: 12px; 
  text-transform: uppercase; 
  letter-spacing: 0.03em; 
}
#m-ovr { 
  font-size: clamp(2rem, 5vw, 3rem); 
  font-weight: 900; 
  font-style: italic; 
  color: var(--text); 
  line-height: 1; 
  flex-shrink: 0;
}

#m-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px; }
.stat-item { position: relative; }
.stat-header { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  margin-bottom: 8px; 
  gap: 8px; 
}
.stat-label { 
  font-size: 12px; 
  font-weight: 700; 
  color: var(--text-secondary); 
  text-transform: uppercase; 
  letter-spacing: 0.03em; 
}
.stat-value { font-size: 12px; font-weight: 800; color: var(--text); }
.stat-bar-bg { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.stat-bar-fill { 
  height: 100%; 
  background: var(--text); 
  border-radius: 3px; 
  width: 0%; 
  transition: width 1s var(--ease-out); 
}
.stat-bar-fill.accent { background: var(--accent); }
.stat-bar-fill.gk { background: var(--accent-gk); }

/* RADAR CHART CONTAINER */
.radar-container {
  width: 100%;
  height: 300px;
  margin: 24px 0;
  position: relative;
}
.radar-canvas {
  width: 100%;
  height: 100%;
}

/* COMPARE LAYOUT */
.compare-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
}
@media (max-width: 640px) {
  .compare-grid { grid-template-columns: 1fr; gap: 24px; }
  .radar-container { height: 250px; }
}
.compare-player { text-align: center; }
.compare-player h3 { margin: 12px 0 4px; font-size: 1.5rem; }
.compare-player .role { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 16px; }

/* CONTROLS */
.controls-row { 
  margin-bottom: 32px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  flex-wrap: wrap; 
  gap: 16px; 
  background: var(--bg-elevated); 
  backdrop-filter: blur(10px); 
  padding: 16px; 
  border-radius: 20px; 
  border: 1px solid var(--border); 
}
.search-input { 
  padding: 12px 20px; 
  border-radius: 100px; 
  border: 1px solid var(--border); 
  background: var(--bg-card); 
  width: 100%; 
  max-width: 320px; 
  font-family: inherit; 
  font-size: 14px; 
  font-weight: 500; 
  transition: all 0.2s; 
  color: var(--text); 
}
.search-input:hover { border-color: var(--border-strong); }
.search-input:focus { 
  outline: none; 
  border-color: var(--accent); 
  box-shadow: 0 0 0 3px rgba(22,163,74,0.1); 
}
.search-input::placeholder { color: var(--text-tertiary); }
.filter-bar { display: flex; gap: 8px; flex-wrap: wrap; }
.filter-btn { 
  padding: 10px 18px; 
  border-radius: 100px; 
  border: 1px solid var(--border); 
  background: var(--bg-card); 
  font-size: 12px; 
  font-weight: 600; 
  cursor: pointer; 
  text-transform: uppercase; 
  letter-spacing: 0.02em; 
  transition: all 0.2s; 
  color: var(--text-secondary); 
  min-height: 40px; 
}
.filter-btn:hover { border-color: var(--border-strong); color: var(--text); }
.filter-btn.active { 
  background: var(--text); 
  color: var(--bg); 
  border-color: var(--text); 
}
.filter-btn.gk.active { background: var(--accent-gk); border-color: var(--accent-gk); }
.filter-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

@media (max-width: 640px) {
  .controls-row { flex-direction: column; align-items: stretch; }
  .search-input { max-width: 100%; }
  .filter-bar { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .filter-bar::-webkit-scrollbar { display: none; }
}

/* FORM ELEMENTS */
.form-group { margin-bottom: 20px; }
.form-label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 8px;
  letter-spacing: 0.05em;
}
.form-input, .form-select {
  width: 100%;
  padding: 14px 18px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text);
  font-family: inherit;
  font-size: 15px;
  transition: all 0.2s;
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(22,163,74,0.1);
}
.form-input::placeholder { color: var(--text-tertiary); }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }
[data-theme="dark"] ::-webkit-scrollbar-thumb { background: var(--border-strong); }

/* MOBILE */
@media (max-width: 1024px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } }

@media (max-width: 768px) {
  .nav-links { display: none; }
  .burger { display: flex; }
  .main-content { padding-left: max(16px, var(--safe-left)); padding-right: max(16px, var(--safe-right)); }
  .intro-block { padding: 40px 0 60px; }
  .intro-block h1 { font-size: clamp(2rem, 10vw, 4rem); }
  .timer-context { width: 100%; padding: 20px; flex-direction: column; gap: 16px; }
  .countdown { gap: 12px; }
  .countdown > div { min-width: 44px; }
  .btn { width: 100%; max-width: 300px; }
  .btn-group { flex-direction: column; align-items: center; }
  .bento-grid { grid-template-columns: 1fr; gap: 16px; }
  .card { padding: 24px; }
  .card.span-2 { grid-column: 1 / -1; }
  .player-card { min-height: 360px; }
  #m-stats { grid-template-columns: 1fr; }
  th, td { padding: 16px 12px; }
}

@media (max-width: 360px) {
  .countdown-value { font-size: 1.5rem; }
  .ovr-badge { font-size: 12px; padding: 5px 12px; }
}

/* SCREENSHOT CONTAINER */
#screenshot-container { 
  position: fixed; 
  top: -9999px; 
  left: -9999px; 
  width: 480px; 
  z-index: -1; 
  pointer-events: none; 
  opacity: 0; 
}
#screenshot-container .modal-content { 
  position: static; 
  max-height: none; 
  overflow: visible; 
  transform: none; 
  margin: 0; 
  box-shadow: none; 
  background: white; 
  padding: 32px; 
  color: #0a0a0a;
}
#screenshot-container .modal-header-fixed { display: none; }
#screenshot-container #m-img-container { margin: 0 0 24px 0; }
#screenshot-container .stat-bar-fill { 
  width: var(--width, 0%) !important; 
  transition: none !important; 
}

/* VIRTUAL SCROLL CONTAINER */
.virtual-container {
  position: relative;
  height: 600px;
  overflow-y: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-elevated);
}
.virtual-content {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}
</style>
</head>
<body>
<a href="#main" class="skip-link">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É</a>

<div class="ptr-indicator" id="ptr">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 5v14M19 12l-7 7-7-7"/>
  </svg>
</div>

<div id="preloader" role="status" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞">
  <div class="preloader-content">
    <div class="preloader-logo">BOX<span class="logo-accent">1</span>V1</div>
    <div class="loading-bar" aria-hidden="true"></div>
  </div>
</div>

<div id="toast-container" role="region" aria-live="polite" aria-atomic="true"></div>
<div id="search-live-region" class="live-region" role="status" aria-live="polite" aria-atomic="true"></div>

<nav id="navbar" role="navigation" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
  <div class="nav-inner">
    <a href="#home" class="logo" onclick="switchTab('home'); return false;" aria-label="BOX1V1 - –ù–∞ –≥–ª–∞–≤–Ω—É—é">
      BOX<span class="logo-accent">1</span>V1
    </a>
    <div class="nav-links">
      <a href="#home" onclick="switchTab('home'); return false;" id="btn-home" class="active" aria-current="page">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="#roster" onclick="switchTab('roster'); return false;" id="btn-roster">–£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
      <a href="#stats" onclick="switchTab('stats'); return false;" id="btn-stats">–†–µ–π—Ç–∏–Ω–≥</a>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
        <span id="theme-icon">üåô</span>
      </button>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" aria-expanded="false" aria-controls="mobile-drawer">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </button>
  </div>
</nav>

<div class="drawer-overlay" id="drawer-overlay" onclick="toggleMenu()" aria-hidden="true"></div>
<div class="mobile-drawer" id="mobile-drawer" role="dialog" aria-label="–ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é" aria-modal="true">
  <a href="#home" onclick="handleMobileNav('home'); return false;">–ì–ª–∞–≤–Ω–∞—è</a>
  <a href="#roster" onclick="handleMobileNav('roster'); return false;">–£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
  <a href="#stats" onclick="handleMobileNav('stats'); return false;">–†–µ–π—Ç–∏–Ω–≥</a>
  <div style="padding: 16px; border-top: 1px solid var(--border); margin-top: 8px;">
    <button class="theme-toggle" onclick="toggleTheme(); toggleMenu()" style="width: 100%; margin: 0; border-radius: 12px;">
      <span id="theme-icon-mobile">üåô –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</span>
    </button>
  </div>
  <div class="btn-group">
    <button class="btn" onclick="handleMobileNav('applyModal', true)" style="width:100%">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
  </div>
</div>

<main id="main" class="main-content">
  <section id="home" class="active" aria-label="–ì–ª–∞–≤–Ω–∞—è">
    <div class="intro-block">
      <span>The Next Gen Football</span>
      <h1>BOX1V1.</h1>
      <p>–†–µ—à–∞–µ—Ç –Ω–µ –∫–æ–º–∞–Ω–¥–∞.<br>–†–µ—à–∞–µ—à—å —Ç—ã.</p>
      <div class="btn-group">
        <button class="btn" onclick="switchTab('roster')">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
        <button class="btn btn-outline" onclick="openModal('applyModal')">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>
      <div class="timer-context" id="timer-container">
        <span class="timer-label" id="timer-status">–î–æ —Å—Ç–∞—Ä—Ç–∞ —Å–µ–∑–æ–Ω–∞:</span>
        <div class="countdown" id="timer">
          <div><div class="countdown-value" id="days">00</div><div class="countdown-label">–¥–Ω</div></div>
          <div><div class="countdown-value" id="hours">00</div><div class="countdown-label">—á—Å</div></div>
          <div><div class="countdown-value" id="mins">00</div><div class="countdown-label">–º–∏–Ω</div></div>
          <div><div class="countdown-value" id="secs">00</div><div class="countdown-label">—Å–µ–∫</div></div>
        </div>
      </div>
    </div>
    <div class="bento-grid">
      <div class="card span-2" onclick="openModal('rulesModal')" tabindex="0" role="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–≥–ª–∞–º–µ–Ω—Ç">
        <span style="font-size:11px; font-weight:700; color:var(--accent); text-transform:uppercase; letter-spacing:0.1em;">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</span>
        <h2>–†–ï–ì–õ–ê–ú–ï–ù–¢.</h2>
        <p>–°–≤–æ–¥ –ø—Ä–∞–≤–∏–ª –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –º–∞—Ç—á–µ–π.</p>
        <div style="margin-top:auto; padding-top:20px; font-weight:700; font-size:12px; text-transform:uppercase; color:var(--text-secondary);">–ò–∑—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ ‚Üí</div>
      </div>
      <div class="card" onclick="window.open('https://t.me/streetbox1v1', '_blank')" tabindex="0" role="link" aria-label="–û—Ç–∫—Ä—ã—Ç—å Telegram">
        <h3>TELEGRAM</h3>
        <p>–°–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.</p>
      </div>
      <div class="card" onclick="window.open('https://instagram.com/box.1v1', '_blank')" tabindex="0" role="link" aria-label="–û—Ç–∫—Ä—ã—Ç—å Instagram">
        <h3>INSTAGRAM</h3>
        <p>–ì–ª–∞–≤–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –≤ –º–µ–¥–∏–∞ —Ñ–æ—Ä–º–∞—Ç–µ.</p>
      </div>
    </div>
  </section>

  <section id="roster" aria-label="–£—á–∞—Å—Ç–Ω–∏–∫–∏">
    <div style="margin-bottom: 32px;">
      <h1 style="font-size: clamp(2rem, 10vw, 6rem);">–£–ß–ê–°–¢–ù–ò–ö–ò.</h1>
      <p style="font-size: 1.125rem; margin-top:8px; color: var(--text-secondary);">–î–µ–π—Å—Ç–≤—É—é—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ BOX1V1. –í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–æ–∏—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.</p>
    </div>
    <div class="controls-row">
      <input type="search" class="search-input" id="playerSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." oninput="debouncedRender()" aria-label="–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞" autocomplete="off">
      <div class="filter-bar" role="group" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏">
        <button class="filter-btn active" onclick="setRoleFilter('–í—Å–µ', this)" aria-pressed="true">–í—Å–µ</button>
        <button class="filter-btn" onclick="setRoleFilter('–ò–≥—Ä–æ–∫', this)" aria-pressed="false">–ü–æ–ª–µ–≤—ã–µ</button>
        <button class="filter-btn gk" onclick="setRoleFilter('–í—Ä–∞—Ç–∞—Ä—å', this)" aria-pressed="false">–í—Ä–∞—Ç–∞—Ä–∏</button>
      </div>
    </div>
    <div class="bento-grid" id="roster-grid" role="region" aria-live="polite" aria-label="–°–µ—Ç–∫–∞ –∏–≥—Ä–æ–∫–æ–≤">
      <!-- Skeleton loading -->
      <div class="card player-card skeleton-card" style="min-height: 380px;">
        <div class="skeleton" style="position:absolute; inset:0;"></div>
      </div>
      <div class="card player-card skeleton-card" style="min-height: 380px;">
        <div class="skeleton" style="position:absolute; inset:0;"></div>
      </div>
      <div class="card player-card skeleton-card" style="min-height: 380px;">
        <div class="skeleton" style="position:absolute; inset:0;"></div>
      </div>
      <div class="card player-card skeleton-card" style="min-height: 380px;">
        <div class="skeleton" style="position:absolute; inset:0;"></div>
      </div>
    </div>
  </section>

  <section id="stats" aria-label="–†–µ–π—Ç–∏–Ω–≥">
    <h1 style="font-size: clamp(2rem, 10vw, 6rem); margin-bottom:32px;">–†–ï–ô–¢–ò–ù–ì.</h1>
    
    <!-- Desktop Table -->
    <div class="table-wrapper" role="region" aria-label="–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞" tabindex="0">
      <table role="table" aria-label="–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤">
        <thead>
          <tr>
            <th scope="col" aria-label="–ü–æ–∑–∏—Ü–∏—è">#</th>
            <th scope="col">–ò–≥—Ä–æ–∫</th>
            <th scope="col" style="text-align:right;">OVR</th>
          </tr>
        </thead>
        <tbody id="stats-body">
          <tr><td colspan="3" style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Mobile Cards -->
    <div class="mobile-stats-grid" id="mobile-stats-grid" role="region" aria-label="–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤"></div>
  </section>
</main>

<!-- Compare Bar -->
<div class="compare-bar" id="compare-bar">
  <span class="compare-count">–í—ã–±—Ä–∞–Ω–æ: <span id="compare-count">0</span>/2</span>
  <div class="compare-actions">
    <button class="btn btn-outline" onclick="clearCompare()" style="min-width: auto; padding: 12px 20px;">–°–±—Ä–æ—Å–∏—Ç—å</button>
    <button class="btn" onclick="openCompareModal()" id="compare-btn" disabled style="min-width: auto; padding: 12px 24px;">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- Player Modal -->
<div class="modal-overlay" id="playerModal" role="dialog" aria-modal="true" aria-labelledby="m-name" onclick="if(event.target === this) closeModal('playerModal')">
  <div class="modal-content" id="stats-card" onclick="event.stopPropagation()" role="document">
    <div class="modal-header-fixed">
      <button id="download-card" class="download-circle" aria-label="–°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏–≥—Ä–æ–∫–∞">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </button>
      <button class="modal-close" onclick="closeModal('playerModal')" aria-label="–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏–≥—Ä–æ–∫–∞">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div id="m-img-container">
      <img id="m-img" src="" alt="–§–æ—Ç–æ –∏–≥—Ä–æ–∫–∞" crossorigin="anonymous" onload="this.classList.add('loaded')">
    </div>
    
    <div class="modal-header">
      <div class="modal-title-group">
        <span id="m-role">ROLE</span>
        <h2 id="m-name">NAME</h2>
        <div id="m-badges" role="list" aria-label="–ë–µ–π–¥–∂–∏ –∏–≥—Ä–æ–∫–∞"></div>
      </div>
      <div id="m-ovr" aria-label="–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥">99</div>
    </div>
    
    <div id="m-stats" role="region" aria-label="–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞"></div>
    
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <button class="btn" style="flex:1; min-width:120px;" onclick="copyPlayerID()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
      <button class="btn btn-outline" style="flex:1; min-width:120px;" onclick="sharePlayer()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>
  </div>
</div>

<!-- Compare Modal -->
<div class="modal-overlay" id="compareModal" role="dialog" aria-modal="true" aria-label="–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤" onclick="if(event.target === this) closeModal('compareModal')">
  <div class="modal-content wide" onclick="event.stopPropagation()">
    <div class="modal-header-fixed">
      <button class="modal-close" onclick="closeModal('compareModal')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <h2 style="font-size: 1.5rem; margin-bottom: 24px; text-align: center;">–°–†–ê–í–ù–ï–ù–ò–ï</h2>
    
    <div class="compare-grid" id="compare-container">
      <!-- Dynamic content -->
    </div>
    
    <div class="radar-container">
      <canvas id="radarCanvas" class="radar-canvas"></canvas>
    </div>
  </div>
</div>

<!-- Apply Modal -->
<div class="modal-overlay" id="applyModal" role="dialog" aria-modal="true" aria-labelledby="apply-title" onclick="if(event.target === this) closeModal('applyModal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header-fixed">
      <button class="modal-close" onclick="closeModal('applyModal')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <h2 id="apply-title" style="font-size:1.5rem; margin:40px 0 16px; line-height:1.2;">–í–°–¢–£–ü–ò–¢–¨ –í BOX1V1</h2>
    <p style="margin-bottom:24px; color:var(--text-secondary); line-height:1.6; font-size: 0.95rem;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ Telegram.</p>
    
    <form id="applyForm" onsubmit="handleApply(event)">
      <div class="form-group">
        <label class="form-label" for="apply-name">–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è</label>
        <input type="text" id="apply-name" class="form-input" required placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
      </div>
      <div class="form-group">
        <label class="form-label" for="apply-role">–ü–æ–∑–∏—Ü–∏—è</label>
        <select id="apply-role" class="form-select" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é</option>
          <option value="–ò–≥—Ä–æ–∫">–ü–æ–ª–µ–≤–æ–π –∏–≥—Ä–æ–∫</option>
          <option value="–í—Ä–∞—Ç–∞—Ä—å">–í—Ä–∞—Ç–∞—Ä—å</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="apply-contact">Telegram –∏–ª–∏ –¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="text" id="apply-contact" class="form-input" required placeholder="@username –∏–ª–∏ +7...">
      </div>
      <button type="submit" class="btn" style="width:100%;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
  </div>
</div>

<!-- Rules Modal -->
<div class="modal-overlay" id="rulesModal" role="dialog" aria-modal="true" aria-labelledby="rules-title" onclick="if(event.target === this) closeModal('rulesModal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header-fixed">
      <button class="modal-close" onclick="closeModal('rulesModal')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <h2 id="rules-title" style="font-size:1.5rem; margin:40px 0 24px; line-height:1.2;">–†–ï–ì–õ–ê–ú–ï–ù–¢</h2>
    <div style="display:flex; flex-direction:column; gap:20px;">
      <article style="padding-bottom:20px; border-bottom:1px solid var(--border);">
        <h3 style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--accent); margin-bottom:6px; letter-spacing:0.1em;">01. –§–æ—Ä–º–∞—Ç</h3>
        <p style="color:var(--text-secondary); line-height:1.6; margin:0; font-size: 0.95rem;">–ú–∞—Ç—á–∏ 1 –Ω–∞ 1 —Å —É—á–∞—Å—Ç–∏–µ–º –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –≤—Ä–∞—Ç–∞—Ä—è.</p>
      </article>
      <article style="padding-bottom:20px; border-bottom:1px solid var(--border);">
        <h3 style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--accent); margin-bottom:6px; letter-spacing:0.1em;">02. –¢–∞–π–º–∏–Ω–≥</h3>
        <p style="color:var(--text-secondary); line-height:1.6; margin:0; font-size: 0.95rem;">–õ–∏–º–∏—Ç –Ω–∞ –∞—Ç–∞–∫—É ‚Äî 20 —Å–µ–∫—É–Ω–¥.</p>
      </article>
      <article>
        <h3 style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--accent); margin-bottom:6px; letter-spacing:0.1em;">03. –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
        <p style="color:var(--text-secondary); line-height:1.6; margin:0; font-size: 0.95rem;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã –¥–æ –¥–≤—É—Ö –≥–æ–ª–æ–≤, –±–µ–∑ –Ω–∏—á—å–∏.</p>
      </article>
    </div>
  </div>
</div>

<!-- Screenshot Container -->
<div id="screenshot-container" aria-hidden="true"></div>

<script>
// ==================== CONFIG & STATE ====================
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREjbeB6jNrU01kw1npVtFTvqGdP134ERjmyROoOYeYXbzjgL0ZCNK6KwF0VTk3c1yxZEZEUsJjy2Ur/pub?output=csv';
const TARGET_DATE = new Date("March 1, 2026 00:00:00").getTime();
const STORAGE_KEY = 'box1v1_players';
const STORAGE_TIME = 'box1v1_last_fetch';

let allPlayers = [];
let filteredPlayers = [];
let currentRoleFilter = '–í—Å–µ';
let compareList = [];
let renderTimeout;
let abortController = null;
let timerInterval;
let lastFocusedElement = null;
let statAnimationTimers = [];
let focusTrapHandler = null;
let touchStartY = 0;
let isRefreshing = false;

const statDefs = {
  'DRI': '–¢–µ—Ö–Ω–∏–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –º—è—á–∞',
  'SPD': '–°–∫–æ—Ä–æ—Å—Ç—å –∏ —Ä—ã–≤–æ–∫',
  'SHT': '–¢–æ—á–Ω–æ—Å—Ç—å —É–¥–∞—Ä–∞',
  'PHY': '–§–∏–∑–∏—á–µ—Å–∫–∞—è –º–æ—â—å',
  'REF': '–†–µ–∞–∫—Ü–∏—è',
  'DIV': '–ü—Ä—ã–∂–æ–∫ –∏ –æ—Ö–≤–∞—Ç',
  'HAN': '–ò–≥—Ä–∞ —Ä—É–∫–∞–º–∏',
  'POS': '–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'
};

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// ==================== INIT ====================
async function init() {
  // Theme init
  initTheme();
  
  // Load data
  await loadData();
  
  // Setup UI
  handleHashAndDeepLink();
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);
  setupDownloadButton();
  setupScrollDetection();
  setupPullToRefresh();
  setup3DTilt();
  
  // Hide preloader
  setTimeout(() => $('#preloader').classList.add('loaded'), 500);
  
  // Visibility change
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      clearInterval(timerInterval);
    } else {
      timerInterval = setInterval(updateTimer, 1000);
    }
  });
}

// ==================== DATA LOADING ====================
async function loadData() {
  // Try cache first for offline
  const cached = localStorage.getItem(STORAGE_KEY);
  const lastFetch = localStorage.getItem(STORAGE_TIME);
  const isStale = !lastFetch || (Date.now() - parseInt(lastFetch) > 3600000); // 1 hour
  
  if (cached && (!navigator.onLine || isStale)) {
    allPlayers = JSON.parse(cached);
    renderRoster();
    renderStats();
    if (!navigator.onLine) showToast('–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', 3000);
    return;
  }
  
  // Fetch fresh
  try {
    if (abortController) abortController.abort();
    abortController = new AbortController();
    
    const response = await fetch(CSV_URL, { signal: abortController.signal });
    if (!response.ok) throw new Error('Network error');
    const text = await response.text();
    allPlayers = parseCSV(text);
    
    // Cache it
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allPlayers));
    localStorage.setItem(STORAGE_TIME, Date.now().toString());
    
    if (allPlayers.length === 0) {
      showToast('–†–æ—Å—Ç–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—É—Å—Ç');
    } else {
      renderRoster();
      renderStats();
    }
  } catch (error) {
    if (error.name === 'AbortError') return;
    console.error('Fetch error:', error);
    
    // Fallback to cache
    if (cached) {
      allPlayers = JSON.parse(cached);
      renderRoster();
      renderStats();
      showToast('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
    } else {
      showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }
  }
}

function parseCSV(text) {
  const lines = text.replace(/\r/g, '').split('\n').filter(r => r.trim());
  if (lines.length < 2) return [];
  
  // Parse headers
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
  const getIndex = (name) => headers.findIndex(h => h.includes(name.toLowerCase()));
  
  const idx = {
    name: getIndex('name'),
    ovr: getIndex('ovr'),
    role: getIndex('role'),
    drib: getIndex('drib'),
    speed: getIndex('speed'),
    shot: getIndex('shot'),
    phys: getIndex('phys'),
    photo: getIndex('photo'),
    status: getIndex('status'),
    badges: getIndex('badges')
  };
  
  const result = [];
  for (let i = 1; i < lines.length; i++) {
    const cells = parseCSVLine(lines[i]);
    if (cells[idx.name]) {
      result.push({
        name: cells[idx.name] || '',
        ovr: parseInt(cells[idx.ovr]) || 0,
        role: cells[idx.role] || '–ò–≥—Ä–æ–∫',
        drib: parseInt(cells[idx.drib]) || 0,
        speed: parseInt(cells[idx.speed]) || 0,
        shot: parseInt(cells[idx.shot]) || 0,
        phys: parseInt(cells[idx.phys]) || 0,
        photo: cells[idx.photo] || '',
        status: cells[idx.status] || '',
        badges: cells[idx.badges] ? cells[idx.badges].split('|').map(b => b.trim()).filter(Boolean) : []
      });
    }
  }
  return result;
}

function parseCSVLine(line) {
  const cells = [];
  let cell = '';
  let inQuotes = false;
  
  for (let j = 0; j < line.length; j++) {
    const char = line[j];
    const nextChar = line[j + 1];
    
    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        cell += '"';
        j++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      cells.push(cell.trim());
      cell = '';
    } else {
      cell += char;
    }
  }
  cells.push(cell.trim());
  return cells;
}

// ==================== RENDERING ====================
function renderRoster() {
  const grid = $('#roster-grid');
  const search = $('#playerSearch').value.toLowerCase().trim();
  filteredPlayers = allPlayers.filter(p => {
    const matchesSearch = p.name.toLowerCase().includes(search);
    const matchesRole = currentRoleFilter === '–í—Å–µ' || p.role === currentRoleFilter;
    return matchesSearch && matchesRole;
  });
  
  announceToScreenReader(`–ù–∞–π–¥–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤: ${filteredPlayers.length}`);
  
  if (filteredPlayers.length === 0) {
    grid.innerHTML = `<div style="grid-column: 1/-1; padding: 60px 20px; text-align: center; color: var(--text-secondary);"><p style="font-size: 1.125rem;">–ê—Ç–ª–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p><p style="font-size: 0.875rem; margin-top: 8px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p></div>`;
    return;
  }
  
  // Virtual scroll if > 50
  if (filteredPlayers.length > 50) {
    renderVirtual(grid, filteredPlayers);
    return;
  }
  
  grid.innerHTML = filteredPlayers.map((p, i) => createPlayerCard(p, i)).join('');
  
  // Load images
  setTimeout(() => {
    filteredPlayers.forEach(p => loadPlayerImage(p));
  }, 100);
}

function createPlayerCard(p, index, isVirtual = false) {
  const playerId = sanitizeId(p.name);
  const isGK = p.role === '–í—Ä–∞—Ç–∞—Ä—å';
  const accentColor = isGK ? 'gk' : '';
  const isSelected = compareList.includes(p.name);
  
  return `
    <div class="card player-card ${isVirtual ? 'virtual-item' : ''}" 
         tabindex="0" 
         role="button" 
         aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–≥—Ä–æ–∫–∞ ${p.name}, —Ä–µ–π—Ç–∏–Ω–≥ ${p.ovr}"
         style="animation: fadeIn 0.5s ${index * 0.05}s forwards; opacity: 0;"
         onclick="handleCardClick(event, '${escapeJs(p.name)}')"
         onkeydown="handlePlayerCardKeydown(event, '${escapeJs(p.name)}')"
         data-name="${escapeJs(p.name)}">
      
      <div class="compare-checkbox ${isSelected ? 'checked' : ''}" 
           onclick="event.stopPropagation(); toggleCompare('${escapeJs(p.name)}')"
           aria-label="${isSelected ? '–£–±—Ä–∞—Ç—å –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è' : '–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é'}"
           role="checkbox" 
           aria-checked="${isSelected}">
        ${isSelected ? '‚úì' : ''}
      </div>
      
      <div class="player-img" id="img-${playerId}" 
           data-src="${p.photo || ''}"
           data-name="${p.name.charAt(0)}"
           aria-hidden="true">
        ${!p.photo ? `<div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:120px; font-weight:900; color:rgba(255,255,255,0.1);">${p.name.charAt(0)}</div>` : ''}
      </div>
      
      ${p.status ? `<div class="status-badge ${accentColor}">${p.status}</div>` : ''}
      
      <div class="player-info">
        <span class="${accentColor}">${p.role}</span>
        <h3>${escapeHtml(p.name)}</h3>
        ${p.badges.length > 0 ? `<div class="player-badges">${escapeHtml(p.badges[0])}</div>` : ''}
        <span class="ovr-badge ${accentColor}">OVR ${p.ovr}</span>
      </div>
    </div>
  `;
}

function renderVirtual(container, players) {
  container.innerHTML = `<div class="virtual-container" id="virtual-container">
    <div class="virtual-content" id="virtual-content" style="height: ${players.length * 400}px;">
      ${players.slice(0, 10).map((p, i) => createPlayerCard(p, i, true)).join('')}
    </div>
  </div>`;
  
  const cont = $('#virtual-container');
  cont.addEventListener('scroll', () => {
    const scrollTop = cont.scrollTop;
    const startIdx = Math.floor(scrollTop / 400);
    const visible = players.slice(startIdx, startIdx + 10);
    $('#virtual-content').innerHTML = visible.map((p, i) => createPlayerCard(p, startIdx + i, true)).join('');
    visible.forEach(p => loadPlayerImage(p));
  });
}

function loadPlayerImage(p) {
  const playerId = sanitizeId(p.name);
  const imgDiv = document.getElementById(`img-${playerId}`);
  if (!imgDiv || imgDiv.classList.contains('loaded')) return;
  
  const url = imgDiv.getAttribute('data-src');
  if (!url || !url.startsWith('http')) {
    imgDiv.classList.add('error');
    return;
  }
  
  const img = new Image();
  img.onload = () => {
    imgDiv.classList.add('loaded');
    imgDiv.style.backgroundImage = `url(${url})`;
  };
  img.onerror = () => {
    imgDiv.classList.add('error');
    // Show initial as fallback
    imgDiv.innerHTML = `<div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:120px; font-weight:900; color:rgba(255,255,255,0.1);">${p.name.charAt(0)}</div>`;
  };
  img.src = url;
}

function renderStats() {
  const sorted = [...allPlayers].sort((a, b) => b.ovr - a.ovr);
  
  // Desktop table
  $('#stats-body').innerHTML = sorted.map((p, i) => `
    <tr onclick="openPlayerModal('${escapeJs(p.name)}')" tabindex="0" role="button" aria-label="${i + 1} –º–µ—Å—Ç–æ, ${p.name}, ${p.role}, —Ä–µ–π—Ç–∏–Ω–≥ ${p.ovr}"
        onkeydown="if(event.key === 'Enter') openPlayerModal('${escapeJs(p.name)}')"
        style="animation: fadeIn 0.3s ${i * 0.03}s forwards; opacity: 0;">
      <td style="font-weight:700; color:var(--text-tertiary); font-variant-numeric: tabular-nums;">${(i + 1).toString().padStart(2, '0')}</td>
      <td>
        <div class="player-row">
          <img src="${p.photo || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23ddd" width="100" height="100"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999">${p.name.charAt(0)}</text></svg>'}" 
               alt="" class="player-avatar-sm" loading="lazy" 
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>${p.name.charAt(0)}</text></svg>'">
          <div class="player-info-sm">
            <div class="player-name-sm">${escapeHtml(p.name)}</div>
            <div class="player-role-sm">${p.role}</div>
          </div>
        </div>
      </td>
      <td style="text-align:right;"><span class="ovr-badge" style="margin:0; ${p.role === '–í—Ä–∞—Ç–∞—Ä—å' ? 'background:var(--accent-gk)' : ''}">${p.ovr}</span></td>
    </tr>
  `).join('');
  
  // Mobile cards
  $('#mobile-stats-grid').innerHTML = sorted.map((p, i) => `
    <div class="mobile-player-card" onclick="openPlayerModal('${escapeJs(p.name)}')">
      <div class="rank">${(i + 1).toString().padStart(2, '0')}</div>
      <img src="${p.photo || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23ddd" width="100" height="100"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999">${p.name.charAt(0)}</text></svg>'}" 
           class="avatar" loading="lazy"
           onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>${p.name.charAt(0)}</text></svg>'">
      <div class="info">
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="role">${p.role}</div>
      </div>
      <div class="ovr" style="${p.role === '–í—Ä–∞—Ç–∞—Ä—å' ? 'color:var(--accent-gk)' : ''}">${p.ovr}</div>
    </div>
  `).join('');
}

// ==================== INTERACTIONS ====================
function handleCardClick(event, name) {
  // If clicking checkbox area, don't open modal
  if (event.target.closest('.compare-checkbox')) return;
  openPlayerModal(name);
}

function handlePlayerCardKeydown(event, name) {
  if (event.key === 'Enter' || event.key === ' ') {
    event.preventDefault();
    handleCardClick(event, name);
  }
}

function debouncedRender() {
  clearTimeout(renderTimeout);
  renderTimeout = setTimeout(renderRoster, 300); // Increased to 300ms
}

function setRoleFilter(role, btn) {
  currentRoleFilter = role;
  $$('.filter-btn').forEach(b => { 
    b.classList.remove('active'); 
    b.setAttribute('aria-pressed', 'false'); 
  });
  btn.classList.add('active');
  btn.setAttribute('aria-pressed', 'true');
  renderRoster();
}

// ==================== COMPARE FEATURE ====================
function toggleCompare(name) {
  const idx = compareList.indexOf(name);
  if (idx > -1) {
    compareList.splice(idx, 1);
  } else {
    if (compareList.length >= 2) {
      showToast('–ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ 2 –∏–≥—Ä–æ–∫–∞');
      return;
    }
    compareList.push(name);
  }
  updateCompareBar();
  renderRoster(); // Re-render to update checkboxes
}

function updateCompareBar() {
  const bar = $('#compare-bar');
  const count = $('#compare-count');
  const btn = $('#compare-btn');
  
  count.textContent = compareList.length;
  btn.disabled = compareList.length !== 2;
  
  if (compareList.length > 0) {
    bar.classList.add('visible');
  } else {
    bar.classList.remove('visible');
  }
}

function clearCompare() {
  compareList = [];
  updateCompareBar();
  renderRoster();
}

function openCompareModal() {
  if (compareList.length !== 2) return;
  
  const p1 = allPlayers.find(p => p.name === compareList[0]);
  const p2 = allPlayers.find(p => p.name === compareList[1]);
  if (!p1 || !p2) return;
  
  const container = $('#compare-container');
  const isGK1 = p1.role === '–í—Ä–∞—Ç–∞—Ä—å';
  const isGK2 = p2.role === '–í—Ä–∞—Ç–∞—Ä—å';
  
  container.innerHTML = `
    <div class="compare-player">
      <div class="compare-img-container">
        <img src="${p1.photo || ''}" class="compare-img ${p1.photo ? 'loaded' : ''}" 
             onload="this.classList.add('loaded')" 
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:60px;font-weight:900;background:var(--bg-elevated);color:var(--text-tertiary);\\'>${p1.name.charAt(0)}</div>'">
      </div>
      <h3>${escapeHtml(p1.name)}</h3>
      <div class="role" style="${isGK1 ? 'color:var(--accent-gk)' : ''}">${p1.role} ‚Ä¢ OVR ${p1.ovr}</div>
    </div>
    <div class="compare-player">
      <div class="compare-img-container">
        <img src="${p2.photo || ''}" class="compare-img ${p2.photo ? 'loaded' : ''}" 
             onload="this.classList.add('loaded')"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:60px;font-weight:900;background:var(--bg-elevated);color:var(--text-tertiary);\\'>${p2.name.charAt(0)}</div>'">
      </div>
      <h3>${escapeHtml(p2.name)}</h3>
      <div class="role" style="${isGK2 ? 'color:var(--accent-gk)' : ''}">${p2.role} ‚Ä¢ OVR ${p2.ovr}</div>
    </div>
  `;
  
  drawRadarChart(p1, p2);
  openModal('compareModal');
}

function drawRadarChart(p1, p2) {
  const canvas = $('#radarCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  const centerX = rect.width / 2;
  const centerY = rect.height / 2;
  const radius = Math.min(centerX, centerY) - 40;
  
  const stats1 = [p1.drib, p1.speed, p1.shot, p1.phys];
  const stats2 = [p2.drib, p2.speed, p2.shot, p2.phys];
  const labels = ['DRI', 'SPD', 'SHT', 'PHY'];
  const angleStep = (Math.PI * 2) / 4;
  
  ctx.clearRect(0, 0, rect.width, rect.height);
  
  // Draw grid
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
  ctx.lineWidth = 1;
  for (let i = 1; i <= 5; i++) {
    ctx.beginPath();
    for (let j = 0; j < 4; j++) {
      const angle = j * angleStep - Math.PI / 2;
      const x = centerX + Math.cos(angle) * (radius * i / 5);
      const y = centerY + Math.sin(angle) * (radius * i / 5);
      if (j === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.stroke();
  }
  
  // Draw axes and labels
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
  ctx.font = '12px Inter';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  
  for (let i = 0; i < 4; i++) {
    const angle = i * angleStep - Math.PI / 2;
    const x = centerX + Math.cos(angle) * radius;
    const y = centerY + Math.sin(angle) * radius;
    
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    const labelX = centerX + Math.cos(angle) * (radius + 25);
    const labelY = centerY + Math.sin(angle) * (radius + 25);
    ctx.fillText(labels[i], labelX, labelY);
  }
  
  // Draw data
  function drawData(stats, color) {
    ctx.fillStyle = color + '33'; // 20% opacity
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    for (let i = 0; i < 4; i++) {
      const angle = i * angleStep - Math.PI / 2;
      const value = stats[i] / 100;
      const x = centerX + Math.cos(angle) * (radius * value);
      const y = centerY + Math.sin(angle) * (radius * value);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  }
  
  const color1 = getComputedStyle(document.body).getPropertyValue('--accent').trim();
  const color2 = getComputedStyle(document.body).getPropertyValue('--text-tertiary').trim();
  
  drawData(stats1, color1);
  drawData(stats2, color2);
}

// ==================== MODALS ====================
function openPlayerModal(name) {
  statAnimationTimers.forEach(clearTimeout);
  statAnimationTimers = [];
  
  const p = allPlayers.find(x => x.name.toLowerCase() === name.toLowerCase());
  if (!p) { showToast('–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  
  lastFocusedElement = document.activeElement;
  $('#m-name').textContent = p.name;
  $('#m-role').textContent = p.role;
  $('#m-role').className = p.role === '–í—Ä–∞—Ç–∞—Ä—å' ? 'gk' : '';
  $('#m-ovr').textContent = p.ovr;
  
  const imgEl = $('#m-img');
  imgEl.classList.remove('loaded');
  
  // Use local image or initials fallback
  if (p.photo && p.photo.startsWith('http')) {
    imgEl.src = p.photo;
    imgEl.style.display = 'block';
    imgEl.nextElementSibling?.remove();
  } else {
    imgEl.style.display = 'none';
    const initial = document.createElement('div');
    initial.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:120px;font-weight:900;background:var(--bg-elevated);color:var(--text-tertiary);';
    initial.textContent = p.name.charAt(0);
    imgEl.parentElement.appendChild(initial);
  }
  
  $('#m-badges').innerHTML = p.badges.map(b => `<span class="badge" role="listitem">${escapeHtml(b)}</span>`).join('') || '';
  
  const isGK = p.role === '–í—Ä–∞—Ç–∞—Ä—å';
  const stats = [
    { key: isGK ? 'REF' : 'DRI', value: p.drib },
    { key: isGK ? 'DIV' : 'SPD', value: p.speed },
    { key: isGK ? 'HAN' : 'SHT', value: p.shot },
    { key: isGK ? 'POS' : 'PHY', value: p.phys }
  ];
  
  $('#m-stats').innerHTML = stats.map(s => `
    <div class="stat-item">
      <div class="stat-header">
        <div class="stat-label-group" title="${statDefs[s.key]}">
          <span class="stat-label">${s.key}</span>
        </div>
        <span class="stat-value">${s.value}</span>
      </div>
      <div class="stat-bar-bg" aria-hidden="true">
        <div class="stat-bar-fill ${isGK ? 'gk' : (s.value >= 90 ? 'accent' : '')}" id="bar-${s.key}" style="width: 0%" data-width="${s.value}%"></div>
      </div>
    </div>
  `).join('');
  
  openModal('playerModal');
  
  // Animate bars with IntersectionObserver-like delay
  stats.forEach((s, index) => {
    const timer = setTimeout(() => {
      const bar = $(`#bar-${s.key}`);
      if (bar) bar.style.width = bar.getAttribute('data-width');
    }, 100 + (index * 100));
    statAnimationTimers.push(timer);
  });
  
  const currentTab = $('section.active')?.id || 'home';
  const slug = sanitizeId(p.name);
  window.history.replaceState(null, null, `#${currentTab}?player=${slug}`);
}

function openModal(id) {
  const modal = $(`#${id}`);
  if (!modal) return;
  
  cleanupModalHandlers();
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  const content = modal.querySelector('.modal-content');
  if (content) {
    focusTrapHandler = createFocusTrap(content);
    document.addEventListener('keydown', focusTrapHandler);
  }
  
  setTimeout(() => {
    const focusable = modal.querySelector('button, [href], input, [tabindex]:not([tabindex="-1"])');
    if (focusable) focusable.focus();
  }, 100);
  
  // Haptic
  if (navigator.vibrate) navigator.vibrate(10);
}

function closeModal(id) {
  const modal = $(`#${id}`);
  if (!modal) return;
  
  statAnimationTimers.forEach(clearTimeout);
  statAnimationTimers = [];
  
  cleanupModalHandlers();
  
  modal.classList.remove('active');
  document.body.style.overflow = '';
  
  if (lastFocusedElement) { 
    lastFocusedElement.focus(); 
    lastFocusedElement = null; 
  }
  
  if (id === 'playerModal' || id === 'compareModal') {
    const currentTab = $('section.active')?.id || 'home';
    window.history.replaceState(null, null, `#${currentTab}`);
  }
}

function cleanupModalHandlers() {
  if (focusTrapHandler) {
    document.removeEventListener('keydown', focusTrapHandler);
    focusTrapHandler = null;
  }
}

function createFocusTrap(element) {
  const focusableElements = element.querySelectorAll('button, [href], input, select, [tabindex]:not([tabindex="-1"])');
  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];
  
  return function(e) {
    if (e.key !== 'Tab') return;
    
    if (e.shiftKey) {
      if (document.activeElement === firstFocusable) {
        lastFocusable.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === lastFocusable) {
        firstFocusable.focus();
        e.preventDefault();
      }
    }
  };
}

// ==================== UTILITIES ====================
function sanitizeId(name) {
  return name.replace(/\s+/g, '-').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9-]/g, '').toLowerCase();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeJs(str) {
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function showToast(message, duration = 3000) {
  const container = $('#toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.setAttribute('role', 'status');
  container.appendChild(toast);
  
  if (navigator.vibrate) navigator.vibrate(20);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    setTimeout(() => toast.remove(), 500);
  }, duration);
}

function announceToScreenReader(message) {
  const region = $('#search-live-region');
  region.textContent = message;
  setTimeout(() => { region.textContent = ''; }, 1000);
}

function handleApply(e) {
  e.preventDefault();
  const name = $('#apply-name').value;
  const role = $('#apply-role').value;
  const contact = $('#apply-contact').value;
  
  const text = `–ó–∞—è–≤–∫–∞ BOX1V1:%0A–ò–º—è: ${encodeURIComponent(name)}%0A–ü–æ–∑–∏—Ü–∏—è: ${encodeURIComponent(role)}%0A–ö–æ–Ω—Ç–∞–∫—Ç: ${encodeURIComponent(contact)}`;
  window.open(`https://t.me/streetbox1v1?text=${text}`, '_blank');
  closeModal('applyModal');
  showToast('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
  e.target.reset();
}

// ==================== THEME ====================
function initTheme() {
  const saved = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  updateThemeIcon(saved);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  updateThemeIcon(next);
  
  // Update meta theme-color
  const metaColor = next === 'dark' ? '#0a0a0a' : '#fafafa';
  $('#theme-meta').setAttribute('content', metaColor);
}

function updateThemeIcon(theme) {
  const icon = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  const text = theme === 'light' ? 'üåô –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É' : '‚òÄÔ∏è –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';
  $('#theme-icon').textContent = icon;
  const mobile = $('#theme-icon-mobile');
  if (mobile) mobile.textContent = text;
}

// ==================== PULL TO REFRESH ====================
function setupPullToRefresh() {
  if (!('ontouchstart' in window)) return;
  
  const ptr = $('#ptr');
  let startY = 0;
  let currentY = 0;
  let pulling = false;
  
  document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  }, { passive: true });
  
  document.addEventListener('touchmove', (e) => {
    if (!pulling) return;
    currentY = e.touches[0].clientY;
    const diff = currentY - startY;
    
    if (diff > 0 && diff < 100) {
      ptr.style.top = (diff / 2 - 60) + 'px';
      ptr.style.transform = `translateX(-50%) rotate(${diff * 2}deg)`;
      ptr.classList.add('visible');
    }
  }, { passive: true });
  
  document.addEventListener('touchend', () => {
    if (!pulling) return;
    pulling = false;
    
    if (currentY - startY > 80) {
      ptr.classList.add('refreshing');
      ptr.style.top = '20px';
      loadData().then(() => {
        ptr.classList.remove('refreshing', 'visible');
        ptr.style.top = '';
        ptr.style.transform = '';
        showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ!');
      });
    } else {
      ptr.classList.remove('visible');
      ptr.style.top = '';
      ptr.style.transform = '';
    }
  });
}

// ==================== 3D TILT ====================
function setup3DTilt() {
  if (!('ontouchstart' in window)) {
    document.addEventListener('mousemove', (e) => {
      const cards = document.querySelectorAll('.player-card');
      cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;
          const rotateX = (y - centerY) / 20;
          const rotateY = (centerX - x) / 20;
          card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
        } else {
          card.style.transform = '';
        }
      });
    });
  }
}

// ==================== DOWNLOAD & SHARE ====================
function setupDownloadButton() {
  const btn = $('#download-card');
  if (!btn || btn.dataset.initialized) return;
  btn.dataset.initialized = 'true';
  
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    btn.style.opacity = '0.5';
    btn.disabled = true;
    showToast('–°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç–æ—á–∫—É...', 3000);
    
    try {
      const img = $('#m-img');
      const container = $('#screenshot-container');
      container.innerHTML = '';
      
      const original = $('#stats-card');
      const clone = original.cloneNode(true);
      clone.querySelector('.modal-header-fixed')?.remove();
      
      // Fix for screenshot
      clone.style.cssText = 'position:static;max-height:none;overflow:visible;transform:none;width:480px;background:white;padding:32px;border-radius:24px;color:#0a0a0a;';
      
      const cloneImg = clone.querySelector('#m-img');
      if (img.complete && img.naturalWidth > 0 && img.src.startsWith('http')) {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          cloneImg.src = canvas.toDataURL('image/png');
          cloneImg.style.opacity = '1';
        } catch (e) {
          // CORS error, use placeholder
          cloneImg.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%23333" width="400" height="400"/></svg>';
        }
      }
      
      clone.querySelectorAll('.stat-bar-fill').forEach(bar => {
        bar.style.width = bar.getAttribute('data-width');
        bar.style.transition = 'none';
      });
      
      container.appendChild(clone);
      await new Promise(r => setTimeout(r, 200));
      
      const canvas = await html2canvas(clone, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: 480,
        height: clone.offsetHeight,
        logging: false
      });
      
      container.innerHTML = '';
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      const file = new File([blob], `BOX1V1_${sanitizeId($('#m-name').textContent)}.png`, { type: 'image/png' });
      
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: `BOX1V1 ${$('#m-name').textContent}` });
      } else {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = file.name;
        link.click();
        URL.revokeObjectURL(url);
      }
      showToast('–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    } catch (err) {
      console.error(err);
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏');
    } finally {
      btn.style.opacity = '';
      btn.disabled = false;
    }
  });
}

async function copyPlayerID() {
  const name = $('#m-name').textContent;
  try {
    await navigator.clipboard.writeText(name);
    showToast('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
  } catch { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
}

async function sharePlayer() {
  const name = $('#m-name').textContent;
  const url = window.location.href;
  const shareData = { title: `BOX1V1 | ${name}`, text: `–ö–∞—Ä—Ç–æ—á–∫–∞ –∞—Ç–ª–µ—Ç–∞ ${name}`, url: url };
  
  if (navigator.share) {
    try { await navigator.share(shareData); } 
    catch (err) { if (err.name !== 'AbortError') fallback(); }
  } else { fallback(); }
  
  function fallback() {
    navigator.clipboard.writeText(url).then(() => showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'));
  }
}

// ==================== NAVIGATION ====================
function switchTab(id, updateHash = true) {
  const target = $(`#${id}`);
  if (!target) return;
  
  $$('section').forEach(s => {
    s.classList.remove('active');
    s.setAttribute('aria-hidden', 'true');
  });
  $$('.nav-links a').forEach(a => {
    a.classList.remove('active');
    a.removeAttribute('aria-current');
  });
  
  target.classList.add('active');
  target.removeAttribute('aria-hidden');
  const btn = $(`#btn-${id}`);
  if (btn) {
    btn.classList.add('active');
    btn.setAttribute('aria-current', 'page');
  }
  
  if (updateHash) {
    window.history.pushState(null, null, `#${id}`);
  }
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Haptic
  if (navigator.vibrate) navigator.vibrate(5);
}

function toggleMenu() {
  const drawer = $('#mobile-drawer');
  const overlay = $('#drawer-overlay');
  const burger = $('#burger');
  const isOpen = drawer.classList.toggle('open');
  overlay.classList.toggle('open');
  burger.classList.toggle('open');
  burger.setAttribute('aria-expanded', isOpen);
  document.body.style.overflow = isOpen ? 'hidden' : '';
}

function handleMobileNav(id, isModal = false) {
  toggleMenu();
  setTimeout(() => isModal ? openModal(id) : switchTab(id), 300);
}

function handleHashAndDeepLink() {
  const hash = window.location.hash;
  if (!hash) return;
  const [hashPart, queryPart] = hash.split('?');
  const cleanHash = hashPart.replace('#', '');
  if (['home', 'roster', 'stats'].includes(cleanHash)) {
    switchTab(cleanHash, false);
  }
  if (queryPart) {
    const params = new URLSearchParams(queryPart);
    const playerName = params.get('player');
    if (playerName) {
      const name = playerName.replace(/-/g, ' ');
      const player = allPlayers.find(p => sanitizeId(p.name) === playerName || p.name.toLowerCase() === name.toLowerCase());
      if (player) setTimeout(() => openPlayerModal(player.name), 300);
    }
  }
}

function setupScrollDetection() {
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      requestAnimationFrame(() => {
        $('#navbar').classList.toggle('scrolled', window.scrollY > 50);
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });
}

function updateTimer() {
  const now = Date.now();
  const diff = TARGET_DATE - now;
  
  if (diff <= 0) {
    $('#timer-status').textContent = '–°–µ–∑–æ–Ω –æ—Ç–∫—Ä—ã—Ç!';
    $('#timer').style.display = 'none';
    clearInterval(timerInterval);
    return;
  }
  
  const days = Math.floor(diff / 86400000);
  const hours = Math.floor((diff % 86400000) / 3600000);
  const mins = Math.floor((diff % 3600000) / 60000);
  const secs = Math.floor((diff % 60000) / 1000);
  
  $('#days').textContent = days.toString().padStart(2, '0');
  $('#hours').textContent = hours.toString().padStart(2, '0');
  $('#mins').textContent = mins.toString().padStart(2, '0');
  $('#secs').textContent = secs.toString().padStart(2, '0');
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal('playerModal');
    closeModal('compareModal');
    closeModal('applyModal');
    closeModal('rulesModal');
  }
});

window.addEventListener('DOMContentLoaded', init);
window.addEventListener('hashchange', handleHashAndDeepLink);

// Service Worker registration for PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
    self.addEventListener('install', e => self.skipWaiting());
    self.addEventListener('activate', e => e.waitUntil(clients.claim()));
    self.addEventListener('fetch', e => {
      e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
    });
  `)).catch(() => {});
}
</script>
</body>
</html>

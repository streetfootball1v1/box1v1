<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BOX1V1 | Pro Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,700;0,900;1,900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000; --card-bg: #0d0d0d; --accent: #39FF14;
      --text: #fff; --text-dim: #666; --border: #1a1a1a;
      --rank-gold: #FFD700; --rank-silver: #C0C0C0; --rank-bronze: #CD7F32;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }

    /* Admin */
    #admin-bar { background: var(--accent); color: #000; padding: 8px; font-size: 10px; font-weight: 900; text-align: center; cursor: pointer; text-transform: uppercase; position: sticky; top: 0; z-index: 2000; }
    #admin-panel { display: none; background: #111; padding: 2rem; border-bottom: 2px solid var(--accent); }

    nav { position: sticky; top: 31px; width: 100%; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); }
    .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; padding: 1rem 2rem; }
    .nav-links a { color: var(--text-dim); text-decoration: none; font-size: 11px; font-weight: 900; margin-left: 2rem; cursor: pointer; }
    .nav-links a.active { color: var(--accent); }

    .container { max-width: 1200px; margin: 40px auto; padding: 0 2rem; min-height: 70vh; }
    section { display: none; opacity: 0; transition: 0.3s; }
    section.active { display: block; opacity: 1; }

    /* Comparison Table */
    .compare-grid { display: grid; grid-template-columns: 1fr 120px 1fr; gap: 2rem; margin-top: 2rem; }
    .comp-card { background: #0d0d0d; padding: 2rem; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
    .comp-stat-row { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .comp-val { font-size: 2rem; font-weight: 900; }
    .better { color: var(--accent); }

    /* Tables */
    .league-table { width: 100%; border-collapse: collapse; }
    .league-table td { padding: 1.2rem; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; }
    
    /* Micro-Graph */
    .mini-graph { display: flex; align-items: flex-end; gap: 4px; height: 40px; margin-top: 10px; }
    .graph-bar { width: 12px; background: var(--accent); border-radius: 2px; transition: 0.5s; }

    .f-btn { background: #111; border: 1px solid var(--border); color: #666; padding: 10px 20px; border-radius: 50px; font-size: 11px; font-weight: 800; cursor: pointer; }
    .f-btn.active { border-color: var(--accent); color: #fff; }

    .overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; padding: 2rem; overflow-y: auto; }
    .close { position: fixed; top: 2rem; right: 2rem; color: var(--accent); font-weight: 900; cursor: pointer; }
  </style>
</head>
<body>

  <div id="admin-bar" onclick="toggleAdmin()">Staff Panel: Submit Match</div>
  <div id="admin-panel">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; max-width: 1000px; margin: 0 auto;">
        <select id="adm-p1"></select>
        <input type="number" id="adm-s1" placeholder="Score 1">
        <input type="number" id="adm-s2" placeholder="Score 2">
        <select id="adm-p2"></select>
        <button class="f-btn active" onclick="processMatch()">Save Result</button>
    </div>
  </div>

  <nav>
    <div class="nav-container">
      <div style="font-weight: 900; font-style: italic;">BOX1V1</div>
      <div class="nav-links">
        <a onclick="showSection('home')" id="btn-home" class="active">RANKING</a>
        <a onclick="showSection('compare')" id="btn-compare">COMPARE</a>
        <a onclick="showSection('matches')" id="btn-matches">HISTORY</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <section id="home" class="active">
        <div style="display: flex; gap: 10px; margin-bottom: 2rem;">
            <button class="f-btn active" onclick="renderTable('all')">ALL</button>
            <button class="f-btn" onclick="renderTable('gold')">GOLD</button>
            <input type="text" id="search" oninput="search()" placeholder="Search..." style="background: #111; border: 1px solid var(--border); color:#fff; padding:0 15px; border-radius:50px; margin-left:auto;">
        </div>
        <table class="league-table"><tbody id="table-body"></tbody></table>
    </section>

    <section id="compare">
        <h1>VERSUS.</h1>
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
            <select id="comp-sel-1" onchange="runCompare()"></select>
            <select id="comp-sel-2" onchange="runCompare()"></select>
        </div>
        <div class="compare-grid" id="compare-results">
            </div>
    </section>

    <section id="matches">
        <h1>LAST BATTLES.</h1>
        <div id="matches-list"></div>
    </section>
  </div>

  <div class="overlay" id="overlay">
    <div class="close" onclick="closeProfile()">[ CLOSE ]</div>
    <div id="ov-content"></div>
  </div>

  <script>
    // --- DATABASE LOGIC ---
    let players = JSON.parse(localStorage.getItem('b1v1_players')) || [];
    let matches = JSON.parse(localStorage.getItem('b1v1_matches')) || [];

    if(players.length === 0) {
        const names = ['Kuznetsov', 'Volkov', 'Ivanov', 'Petrov', 'Smirnov', 'Mironov', 'Popov', 'Zuparov', 'Sidorov', 'Dmitriev'];
        players = names.map((n, i) => ({
            id: i, n, r: 80 - i, w: 10, d: 2, l: 3,
            history: [75, 77, 76, 78, 80], // История OVR для графика
            form: ['W','W','L','W','W']
        }));
        save();
    }

    function save() {
        localStorage.setItem('b1v1_players', JSON.stringify(players));
        localStorage.setItem('b1v1_matches', JSON.stringify(matches));
    }

    // --- UI LOGIC ---
    window.onload = () => {
        players.sort((a,b) => b.r - a.r);
        renderTable('all');
        updateSelectors();
    };

    function renderTable(filter) {
        const body = document.getElementById('table-body');
        let data = players;
        if(filter === 'gold') data = players.filter(p => p.r >= 80);
        
        body.innerHTML = data.map((p, i) => `
            <tr onclick="openProfile(${p.id})">
                <td style="width:40px; font-weight:900;">#${i+1}</td>
                <td style="font-weight:800;">${p.n.toUpperCase()}</td>
                <td style="color:var(--text-dim); font-size:10px;">WR: ${((p.w/(p.w+p.l+p.d))*100).toFixed(0)}%</td>
                <td style="text-align:right; font-weight:900; color:${getRankColor(p.r)}">${p.r}</td>
            </tr>
        `).join('');
    }

    function updateSelectors() {
        const opts = players.map(p => `<option value="${p.id}">${p.n}</option>`).join('');
        ['adm-p1', 'adm-p2', 'comp-sel-1', 'comp-sel-2'].forEach(id => {
            document.getElementById(id).innerHTML = opts;
        });
    }

    function processMatch() {
        const p1 = players.find(x => x.id == document.getElementById('adm-p1').value);
        const p2 = players.find(x => x.id == document.getElementById('adm-p2').value);
        const s1 = parseInt(document.getElementById('adm-s1').value);
        const s2 = parseInt(document.getElementById('adm-s2').value);

        if(p1.id === p2.id) return alert("Select different players");

        if(s1 > s2) { p1.r += 2; p1.w++; p2.r -= 1; p2.l++; p1.form.unshift('W'); p2.form.unshift('L'); }
        else if(s2 > s1) { p2.r += 2; p2.w++; p1.r -= 1; p1.l++; p2.form.unshift('W'); p1.form.unshift('L'); }
        else { p1.d++; p2.d++; p1.form.unshift('D'); p2.form.unshift('D'); }

        p1.history.push(p1.r); p2.history.push(p2.r);
        p1.history = p1.history.slice(-5); p2.history = p2.history.slice(-5);
        p1.form = p1.form.slice(0,5); p2.form = p2.form.slice(0,5);

        matches.unshift({n1: p1.n, n2: p2.n, s1, s2});
        save();
        location.reload(); // Перезагрузка для обновления всех данных
    }

    function runCompare() {
        const p1 = players.find(x => x.id == document.getElementById('comp-sel-1').value);
        const p2 = players.find(x => x.id == document.getElementById('comp-sel-2').value);
        
        const wr1 = (p1.w/(p1.w+p1.l+p1.d)*100).toFixed(0);
        const wr2 = (p2.w/(p2.w+p2.l+p2.d)*100).toFixed(0);

        document.getElementById('compare-results').innerHTML = `
            <div class="comp-card">
                <div style="font-size:3rem; font-weight:900;">${p1.r}</div>
                <div class="label">${p1.n}</div>
                <div class="comp-stat-row">
                    <div class="comp-val ${wr1 > wr2 ? 'better' : ''}">${wr1}%</div>
                    <div class="label">WINRATE</div>
                </div>
            </div>
            <div style="align-self:center; text-align:center; font-weight:900; color:var(--text-dim);">VS</div>
            <div class="comp-card">
                <div style="font-size:3rem; font-weight:900;">${p2.r}</div>
                <div class="label">${p2.n}</div>
                <div class="comp-stat-row">
                    <div class="comp-val ${wr2 > wr1 ? 'better' : ''}">${wr2}%</div>
                    <div class="label">WINRATE</div>
                </div>
            </div>
        `;
    }

    function openProfile(id) {
        const p = players.find(x => x.id === id);
        const maxH = Math.max(...p.history);
        const minH = Math.min(...p.history);

        document.getElementById('ov-content').innerHTML = `
            <h1 style="font-size: 5rem;">${p.n.toUpperCase()}</h1>
            <div style="font-size: 10rem; font-weight:900; color:${getRankColor(p.r)}">${p.r}</div>
            
            <div style="margin-top: 2rem;">
                <span class="label">Rating Trend (Last 5 Games)</span>
                <div class="mini-graph">
                    ${p.history.map(h => {
                        const height = ((h - minH + 5) / (maxH - minH + 10)) * 40;
                        return `<div class="graph-bar" style="height:${height}px" title="OVR: ${h}"></div>`
                    }).join('')}
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:3rem;">
                <div style="background:#111; padding:2rem; border-radius:15px;">
                    <span class="label">Total Wins</span>
                    <div style="font-size:3rem; font-weight:900;">${p.w}</div>
                </div>
                <div style="background:#111; padding:2rem; border-radius:15px;">
                    <span class="label">Current Form</span>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        ${p.form.map(f => `<div style="width:15px; height:15px; background:${f==='W'?'var(--accent)':f==='L'?'#f33':'#555'}"></div>`).join('')}
                    </div>
                </div>
            </div>
        `;
        document.getElementById('overlay').style.display = 'block';
    }

    function getRankColor(r) {
        if(r >= 80) return 'var(--rank-gold)';
        if(r >= 70) return 'var(--rank-silver)';
        return 'var(--rank-bronze)';
    }

    function toggleAdmin() {
        const el = document.getElementById('admin-panel');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function closeProfile() { document.getElementById('overlay').style.display = 'none'; }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
        document.getElementById('btn-'+id).classList.add('active');
        if(id === 'matches') renderMatches();
    }

    function renderMatches() {
        document.getElementById('matches-list').innerHTML = matches.map(m => `
            <div style="display:flex; justify-content:space-between; padding:1.5rem; background:#0d0d0d; border:1px solid var(--border); border-radius:15px; margin-bottom:10px;">
                <span>${m.n1}</span>
                <span style="font-weight:900; color:var(--accent);">${m.s1} : ${m.s2}</span>
                <span>${m.n2}</span>
            </div>
        `).join('');
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover"/>
<meta name="theme-color" content="#0a0a0a">
<title>BOX1V1 | УЛИЧНЫЙ ФУТБОЛ 1 НА 1</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
  --bg: #fafafa;
  --bg-elevated: rgba(255, 255, 255, 0.8);
  --text: #0a0a0a;
  --text-secondary: #374151;
  --text-tertiary: #6b7280;
  --accent: #16a34a;
  --border: rgba(0,0,0,0.08);
  --border-strong: rgba(0,0,0,0.15);
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --nav-h: 72px;
  --radius: 24px;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
  --ease-out: cubic-bezier(0.2, 0, 0, 1);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
}

@media (max-width: 420px) { :root { --nav-h: 64px; } }

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

@media (prefers-reduced-motion: reduce) {
  html { scroll-behavior: auto; }
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

html { scroll-behavior: smooth; background: var(--bg); -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }

body { 
  font-family: var(--font-sans); 
  background: var(--bg); 
  color: var(--text); 
  line-height: 1.6; 
  overflow-x: hidden; 
  min-height: 100vh; 
  min-height: 100dvh; 
}

h1, h2, h3 { 
  font-weight: 900; 
  font-style: italic; 
  letter-spacing: -0.03em; 
  line-height: 1.15; 
  text-transform: uppercase; 
}

.skip-link { 
  position: absolute; 
  top: -40px; 
  left: 0; 
  background: var(--text); 
  color: white; 
  padding: 8px; 
  text-decoration: none; 
  z-index: 10000; 
  transition: top 0.3s; 
}
.skip-link:focus { top: 0; }

/* PRELOADER */
#preloader { 
  position: fixed; 
  inset: 0; 
  background: var(--bg); 
  z-index: 9999; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  transition: opacity 0.6s var(--ease-out), visibility 0.6s; 
}
#preloader.loaded { 
  opacity: 0; 
  visibility: hidden; 
  pointer-events: none; 
}
.preloader-content { text-align: center; padding: 20px; }
.preloader-logo { 
  font-size: clamp(2rem, 8vw, 3rem); 
  font-weight: 900; 
  font-style: italic; 
  letter-spacing: -0.05em; 
  margin-bottom: 1.5rem; 
  animation: pulse 2s infinite; 
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.loading-bar { 
  width: 160px; 
  height: 3px; 
  background: rgba(0,0,0,0.05); 
  border-radius: 3px; 
  overflow: hidden; 
  margin: 0 auto; 
  position: relative; 
}
.loading-bar::after { 
  content: ''; 
  position: absolute; 
  left: -50%; 
  width: 50%; 
  height: 100%; 
  background: var(--text); 
  animation: load 1.2s infinite ease-in-out; 
  border-radius: 3px; 
}
@keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

/* TOASTS */
#toast-container { 
  position: fixed; 
  bottom: max(24px, calc(var(--safe-bottom) + 8px)); 
  left: 50%; 
  transform: translateX(-50%); 
  z-index: 10001; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
  pointer-events: none; 
  width: calc(100% - 40px); 
  max-width: 400px; 
}
.toast { 
  background: rgba(0,0,0,0.9); 
  backdrop-filter: blur(12px); 
  color: #fff; 
  padding: 16px 24px; 
  border-radius: 100px; 
  font-size: 14px; 
  font-weight: 600; 
  box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
  animation: toastIn 0.4s var(--ease-spring) forwards; 
  pointer-events: auto; 
  text-align: center; 
}
@keyframes toastIn { 
  from { opacity: 0; transform: translateY(20px) scale(0.9); } 
  to { opacity: 1; transform: translateY(0) scale(1); } 
}

/* LIVE REGION */
.live-region { position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden; }

/* NAVIGATION */
nav { 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: calc(var(--nav-h) + var(--safe-top)); 
  padding-top: var(--safe-top); 
  background: rgba(255,255,255,0.95); 
  backdrop-filter: blur(20px); 
  -webkit-backdrop-filter: blur(20px); 
  z-index: 1000; 
  border-bottom: 1px solid var(--border); 
  transition: box-shadow 0.3s; 
}
nav.scrolled { 
  box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
}
@supports not (backdrop-filter: blur(20px)) {
  nav { background: rgba(255,255,255,0.98); }
}
.nav-inner { 
  max-width: 1300px; 
  margin: 0 auto; 
  height: var(--nav-h); 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  padding: 0 max(20px, var(--safe-left)) 0 max(20px, var(--safe-right)); 
}

.logo { 
  font-size: 1.5rem; 
  font-weight: 900; 
  font-style: italic; 
  letter-spacing: -0.03em; 
  cursor: pointer; 
  transition: opacity 0.2s; 
  text-decoration: none; 
  color: var(--text); 
  padding: 8px 0; 
}
.logo:hover { opacity: 0.7; }
.logo-accent { color: var(--accent); }

.nav-links { display: flex; gap: 8px; }
.nav-links a { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  text-decoration: none; 
  font-size: 12px; 
  font-weight: 700; 
  letter-spacing: 0.05em; 
  text-transform: uppercase; 
  color: var(--text-secondary); 
  padding: 10px 20px; 
  border-radius: 100px; 
  transition: all 0.2s; 
  min-height: 44px; 
  border: 1px solid transparent; 
}
.nav-links a:hover, .nav-links a:focus { 
  color: var(--text); 
  background: rgba(0,0,0,0.03); 
}
.nav-links a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
.nav-links a.active { 
  background: var(--text); 
  color: #fff; 
  border-color: var(--text); 
}

/* BURGER */
.burger { 
  display: none; 
  cursor: pointer; 
  width: 44px; 
  height: 44px; 
  flex-direction: column; 
  justify-content: center; 
  align-items: center; 
  gap: 5px; 
  border-radius: 12px; 
  background: rgba(0,0,0,0.03); 
  border: none; 
  transition: all 0.3s; 
}
.burger:hover { background: rgba(0,0,0,0.06); }
.burger:active { transform: scale(0.95); }
.burger span { 
  width: 20px; 
  height: 2px; 
  background: var(--text); 
  border-radius: 2px; 
  transition: all 0.3s; 
}
.burger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
.burger.open span:nth-child(2) { opacity: 0; }
.burger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

/* MOBILE MENU - Bottom Sheet */
.drawer-overlay { 
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,0.4); 
  z-index: 1999; 
  opacity: 0; 
  visibility: hidden; 
  transition: all 0.3s; 
}
.drawer-overlay.open { opacity: 1; visibility: visible; }

.mobile-drawer { 
  position: fixed; 
  left: 0; 
  right: 0; 
  bottom: -100%; 
  max-height: 70vh; 
  background: rgba(255,255,255,0.98); 
  backdrop-filter: blur(20px); 
  -webkit-backdrop-filter: blur(20px); 
  z-index: 2000; 
  padding: 20px 24px calc(24px + var(--safe-bottom)); 
  border-radius: 24px 24px 0 0; 
  transition: bottom 0.4s var(--ease-spring); 
  box-shadow: 0 -10px 40px rgba(0,0,0,0.15); 
}
.mobile-drawer.open { bottom: 0; }
.mobile-drawer::before {
  content: '';
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 4px;
  background: rgba(0,0,0,0.1);
  border-radius: 2px;
}
.mobile-drawer a { 
  display: block;
  font-size: 1.25rem; 
  font-weight: 700; 
  text-decoration: none; 
  color: var(--text); 
  padding: 16px 0; 
  border-bottom: 1px solid var(--border); 
  text-align: center; 
  transition: color 0.2s; 
}
.mobile-drawer a:last-of-type { border-bottom: none; }
.mobile-drawer a:hover, .mobile-drawer a:focus { 
  color: var(--accent); 
}
.mobile-drawer a:focus-visible { 
  outline: 2px solid var(--accent); 
  outline-offset: 4px; 
  border-radius: 4px; 
}
.mobile-drawer .btn-group { 
  margin-top: 24px; 
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* MAIN */
.main-content { 
  max-width: 1300px; 
  margin: 0 auto; 
  padding: calc(var(--nav-h) + var(--safe-top) + 20px) max(20px, var(--safe-left)) calc(100px + var(--safe-bottom)) max(20px, var(--safe-right)); 
  min-height: 100vh; 
  min-height: 100dvh; 
}

section { display: none; opacity: 0; animation: fadeIn 0.6s var(--ease-out) forwards; }
section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* INTRO */
.intro-block { padding: 60px 0 80px; text-align: center; max-width: 900px; margin: 0 auto; }
.intro-block span { 
  display: block; 
  font-size: 12px; 
  font-weight: 800; 
  text-transform: uppercase; 
  letter-spacing: 0.2em; 
  color: var(--accent); 
  margin-bottom: 20px; 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.2s forwards; 
}
.intro-block h1 { 
  font-size: clamp(2.5rem, 10vw, 6rem); 
  margin-bottom: 20px; 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.3s forwards; 
  line-height: 1.1; 
}
.intro-block p { 
  font-size: clamp(1rem, 2.5vw, 1.25rem); 
  color: var(--text-secondary); 
  max-width: 500px; 
  margin: 0 auto 32px; 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.4s forwards; 
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

.btn-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; opacity: 0; animation: fadeInUp 0.6s 0.5s forwards; }

/* BUTTONS */
.btn { 
  padding: 16px 28px; 
  border-radius: 100px; 
  font-weight: 700; 
  text-transform: uppercase; 
  font-size: 13px; 
  letter-spacing: 0.03em; 
  cursor: pointer; 
  transition: all 0.25s var(--ease-out); 
  border: none; 
  text-decoration: none; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px; 
  min-height: 52px; 
  min-width: 140px; 
  background: var(--text); 
  color: #fff; 
}
.btn:hover, .btn:focus { 
  transform: translateY(-2px); 
  box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
}
.btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 3px; }
.btn-outline { 
  background: transparent; 
  border: 1.5px solid var(--border-strong); 
  color: var(--text); 
}
.btn-outline:hover, .btn-outline:focus { 
  background: rgba(0,0,0,0.02); 
  border-color: var(--text); 
}

@media (hover: none) and (pointer: coarse) {
  .btn:hover { transform: none !important; }
  .btn:active { transform: scale(0.96); opacity: 0.9; }
}

/* TIMER */
.timer-context { 
  margin-top: 48px; 
  padding: 20px 32px; 
  background: rgba(255,255,255,0.8); 
  backdrop-filter: blur(10px); 
  border-radius: 20px; 
  display: inline-flex; 
  align-items: center; 
  gap: 24px; 
  border: 1px solid var(--border); 
  opacity: 0; 
  animation: fadeInUp 0.6s 0.6s forwards; 
  flex-wrap: wrap; 
  justify-content: center; 
}
.timer-label { 
  font-size: 12px; 
  font-weight: 700; 
  color: var(--text-secondary); 
  text-transform: uppercase; 
  letter-spacing: 0.1em; 
}
.countdown { display: flex; gap: 16px; }
.countdown > div { text-align: center; min-width: 48px; }
.countdown-value { 
  font-size: clamp(1.5rem, 4vw, 2rem); 
  font-weight: 900; 
  line-height: 1; 
  font-variant-numeric: tabular-nums; 
}
.countdown-label { 
  font-size: 10px; 
  font-weight: 700; 
  color: var(--text-tertiary); 
  text-transform: uppercase; 
  margin-top: 4px; 
}

/* BENTO GRID */
.bento-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 40px; }
.card { 
  background: rgba(255,255,255,0.8); 
  backdrop-filter: blur(10px); 
  border-radius: var(--radius); 
  border: 1px solid var(--border); 
  padding: 28px; 
  position: relative; 
  overflow: hidden; 
  transition: all 0.3s var(--ease-out); 
  cursor: pointer; 
  display: flex; 
  flex-direction: column; 
  gap: 12px; 
}
@media (hover: hover) { 
  .card:hover { 
    transform: translateY(-4px); 
    border-color: var(--border-strong); 
    box-shadow: 0 12px 24px rgba(0,0,0,0.08); 
  } 
}
.card:active { transform: scale(0.98); }
.card:focus-visible { outline: 2px solid var(--accent); outline-offset: 4px; }
.card h2 { font-size: clamp(1.5rem, 3vw, 2rem); line-height: 1.1; }
.card h3 { font-size: 1.25rem; line-height: 1.2; }
.card p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }

/* PLAYER CARDS - ИСПРАВЛЕННЫЕ */
.player-card { 
  min-height: 380px; 
  background: linear-gradient(180deg, #2a2a2a 0%, #000 100%); 
  color: #fff; 
  border: none; 
  padding: 24px; 
  position: relative; 
  border-radius: var(--radius); 
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ИСПРАВЛЕНИЕ ФОТО: добавлена проверка через JS + fallback */
.player-img { 
  position: absolute; 
  inset: 0; 
  background-size: cover; 
  background-position: center top; 
  background-repeat: no-repeat;
  filter: grayscale(1) brightness(0.6);
  opacity: 0; /* Скрыто до загрузки */
  transition: opacity 0.5s, filter 0.5s, transform 0.5s; 
  z-index: 0;
}
.player-img.loaded { opacity: 0.6; }
.player-img.error { 
  background: linear-gradient(135deg, #444 0%, #222 100%) !important; 
  opacity: 0.4; 
}
@media (hover: hover) { 
  .player-card:hover .player-img.loaded { 
    filter: grayscale(0) brightness(0.7); 
    opacity: 0.7; 
    transform: scale(1.03); 
  } 
}

/* Градиент не перекрывает нижнюю часть где текст */
.player-card::after { 
  content: ''; 
  position: absolute; 
  bottom: 0;
  left: 0;
  right: 0;
  height: 70%;
  background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 40%, transparent 100%); 
  z-index: 1;
  pointer-events: none; 
}

.player-info { 
  position: relative; 
  z-index: 2; 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 6px; 
  padding-bottom: 4px;
}

/* ИСПРАВЛЕНИЕ ОБРЕЗАННЫХ БУКВ: разрешен перенос */
.player-info h3 { 
  font-size: clamp(1.2rem, 3vw, 1.6rem); 
  line-height: 1.25; 
  margin: 0;
  overflow-wrap: break-word;
  word-wrap: break-word;
  hyphens: auto;
  max-width: 100%;
  display: -webkit-box;
  -webkit-line-clamp: 3; /* Максимум 3 строки */
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

.player-info span { 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--accent); 
  letter-spacing: 0.1em; 
}
.player-badges { 
  font-size: 11px; 
  color: rgba(255,255,255,0.6); 
  font-weight: 500;
}

/* ИСПРАВЛЕНИЕ OVR: точно виден */
.ovr-badge { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  padding: 6px 14px; 
  background: var(--accent); 
  color: #fff; 
  border-radius: 100px; 
  font-weight: 800; 
  font-size: 13px; 
  margin-top: 12px; 
  width: fit-content; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  position: relative;
  z-index: 10; /* Выше всех */
  align-self: flex-start;
}

.status-badge {
  position: absolute; 
  top: 16px; 
  right: 16px; 
  z-index: 5; 
  background: var(--accent); 
  color: #fff; 
  font-size: 10px; 
  font-weight: 700; 
  padding: 4px 10px; 
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* TABLE */
.table-wrapper { 
  background: rgba(255,255,255,0.8); 
  backdrop-filter: blur(10px); 
  border-radius: var(--radius); 
  border: 1px solid var(--border); 
  overflow: hidden; 
  overflow-x: auto; 
  -webkit-overflow-scrolling: touch; 
}
table { width: 100%; border-collapse: collapse; min-width: 400px; }
th { 
  text-align: left; 
  padding: 20px 24px; 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--text-tertiary); 
  letter-spacing: 0.05em; 
  border-bottom: 1px solid var(--border); 
  white-space: nowrap; 
}
td { padding: 16px 24px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tbody tr { cursor: pointer; transition: background 0.2s; }
tbody tr:hover, tbody tr:focus-within { background: rgba(0,0,0,0.02); }
tbody tr:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }

.player-row { display: flex; align-items: center; gap: 12px; }
.player-avatar-sm { 
  width: 40px; 
  height: 40px; 
  border-radius: 12px; 
  object-fit: cover; 
  background: var(--bg); 
  flex-shrink: 0; 
}
.player-info-sm { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.player-name-sm { 
  font-weight: 700; 
  text-transform: uppercase; 
  font-style: italic; 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  font-size: 0.95rem;
}
.player-role-sm { 
  font-size: 11px; 
  font-weight: 600; 
  color: var(--text-tertiary); 
  text-transform: uppercase; 
  letter-spacing: 0.05em; 
}

/* MODAL */
.modal-overlay { 
  position: fixed; 
  inset: 0; 
  background: rgba(255,255,255,0.95); 
  backdrop-filter: blur(20px); 
  -webkit-backdrop-filter: blur(20px); 
  z-index: 3000; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  padding: 20px; 
  opacity: 0; 
  visibility: hidden; 
  transition: all 0.3s; 
}
.modal-overlay.active { opacity: 1; visibility: visible; }
@supports not (backdrop-filter: blur(20px)) {
  .modal-overlay { background: rgba(255,255,255,0.98); }
}

.modal-content { 
  background: #fff; 
  width: 100%; 
  max-width: 480px; 
  border-radius: 24px; 
  padding: 32px; 
  position: relative; 
  max-height: 90vh; 
  max-height: 90dvh; 
  overflow-y: auto; 
  box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
  border: 1px solid var(--border); 
  transform: translateY(20px); 
  transition: transform 0.3s var(--ease-spring); 
}
.modal-overlay.active .modal-content { transform: translateY(0); }

/* Кнопки в модалке - sticky на десктопе, static на мобильном */
.modal-header-fixed { 
  position: sticky; 
  top: -32px;
  right: 0; 
  left: 0;
  display: flex; 
  justify-content: flex-end;
  gap: 8px; 
  z-index: 10; 
  margin: -32px -32px 16px -32px;
  padding: 16px 20px;
  background: linear-gradient(to bottom, rgba(255,255,255,0.9), transparent);
  pointer-events: none;
}
.modal-header-fixed > button { pointer-events: auto; }

@media (max-width: 640px) {
  .modal-header-fixed {
    position: static;
    margin: 0 0 16px 0;
    padding: 0;
    background: none;
    justify-content: flex-end;
  }
  .modal-content { padding: 24px; max-height: 100vh; border-radius: 0; }
}

.modal-close, .download-circle { 
  width: 40px; 
  height: 40px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  border: 1px solid var(--border); 
  transition: all 0.2s; 
  background: #fff; 
  color: var(--text-secondary); 
}
.modal-close:hover, .download-circle:hover, .modal-close:focus, .download-circle:focus { 
  background: var(--bg); 
  color: var(--text); 
  border-color: var(--border-strong); 
}
.modal-close:focus-visible, .download-circle:focus-visible { 
  outline: 2px solid var(--accent); 
  outline-offset: 2px; 
}

#m-img-container { 
  width: 100%; 
  aspect-ratio: 1 / 1; 
  max-height: 280px; 
  border-radius: 16px; 
  overflow: hidden; 
  background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); 
  background-size: 200% 100%; 
  animation: shimmer 1.5s infinite; 
  margin-bottom: 24px; 
  margin-top: 0;
  position: relative; 
}
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
#m-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
#m-img.loaded { opacity: 1; animation: none; }

.modal-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
  gap: 16px; 
  margin-bottom: 24px; 
  word-break: break-word;
}
.modal-title-group { flex: 1; min-width: 0; }
#m-role { 
  display: inline-block; 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--accent); 
  background: rgba(22,163,74,0.08); 
  padding: 6px 12px; 
  border-radius: 20px; 
  margin-bottom: 8px; 
  letter-spacing: 0.05em; 
}
#m-name { 
  font-size: clamp(1.5rem, 4vw, 2rem); 
  line-height: 1.2; 
}
#m-badges { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
.badge { 
  font-size: 10px; 
  font-weight: 700; 
  background: var(--text); 
  color: #fff; 
  padding: 4px 10px; 
  border-radius: 12px; 
  text-transform: uppercase; 
  letter-spacing: 0.03em; 
}
#m-ovr { 
  font-size: clamp(2rem, 5vw, 3rem); 
  font-weight: 900; 
  font-style: italic; 
  color: var(--text); 
  line-height: 1; 
  flex-shrink: 0;
}

#m-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px; }
.stat-item { position: relative; }
.stat-header { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  margin-bottom: 8px; 
  gap: 8px; 
}
.stat-label { 
  font-size: 12px; 
  font-weight: 700; 
  color: var(--text-secondary); 
  text-transform: uppercase; 
  letter-spacing: 0.03em; 
}
.stat-value { font-size: 12px; font-weight: 800; color: var(--text); }
.stat-bar-bg { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.stat-bar-fill { 
  height: 100%; 
  background: var(--text); 
  border-radius: 3px; 
  width: 0%; 
  transition: width 1s var(--ease-out) 0.2s; 
}
.stat-bar-fill.accent { background: var(--accent); }

/* CONTROLS */
.controls-row { 
  margin-bottom: 32px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  flex-wrap: wrap; 
  gap: 16px; 
  background: rgba(255,255,255,0.6); 
  backdrop-filter: blur(10px); 
  padding: 16px; 
  border-radius: 20px; 
  border: 1px solid var(--border); 
}
.search-input { 
  padding: 12px 20px; 
  border-radius: 100px; 
  border: 1px solid var(--border); 
  background: #fff; 
  width: 100%; 
  max-width: 320px; 
  font-family: inherit; 
  font-size: 14px; 
  font-weight: 500; 
  transition: all 0.2s; 
  color: var(--text); 
}
.search-input:hover { border-color: var(--border-strong); }
.search-input:focus { 
  outline: none; 
  border-color: var(--accent); 
  box-shadow: 0 0 0 3px rgba(22,163,74,0.1); 
}
.search-input::placeholder { color: var(--text-tertiary); }
.filter-bar { display: flex; gap: 8px; flex-wrap: wrap; }
.filter-btn { 
  padding: 10px 18px; 
  border-radius: 100px; 
  border: 1px solid var(--border); 
  background: #fff; 
  font-size: 12px; 
  font-weight: 600; 
  cursor: pointer; 
  text-transform: uppercase; 
  letter-spacing: 0.02em; 
  transition: all 0.2s; 
  color: var(--text-secondary); 
  min-height: 40px; 
}
.filter-btn:hover { border-color: var(--border-strong); color: var(--text); }
.filter-btn.active { 
  background: var(--text); 
  color: #fff; 
  border-color: var(--text); 
}
.filter-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

@media (max-width: 640px) {
  .controls-row { flex-direction: column; align-items: stretch; }
  .search-input { max-width: 100%; }
  .filter-bar { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .filter-bar::-webkit-scrollbar { display: none; }
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }

/* MOBILE */
@media (max-width: 1024px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } }

@media (max-width: 768px) {
  .nav-links { display: none; }
  .burger { display: flex; }
  .main-content { padding-left: max(16px, var(--safe-left)); padding-right: max(16px, var(--safe-right)); }
  .intro-block { padding: 40px 0 60px; }
  .intro-block h1 { font-size: clamp(2rem, 10vw, 4rem); }
  .timer-context { width: 100%; padding: 20px; flex-direction: column; gap: 16px; }
  .countdown { gap: 12px; }
  .countdown > div { min-width: 44px; }
  .btn { width: 100%; max-width: 300px; }
  .btn-group { flex-direction: column; align-items: center; }
  .bento-grid { grid-template-columns: 1fr; gap: 16px; }
  .card { padding: 24px; }
  .card.span-2 { grid-column: 1 / -1; }
  .player-card { min-height: 360px; }
  #m-stats { grid-template-columns: 1fr; }
  th, td { padding: 16px 12px; }
}

@media (max-width: 360px) {
  .countdown-value { font-size: 1.5rem; }
  .ovr-badge { font-size: 12px; padding: 5px 12px; }
}

/* Скрытый контейнер для скриншотов */
#screenshot-container { 
  position: fixed; 
  top: -9999px; 
  left: -9999px; 
  width: 480px; 
  z-index: -1; 
  pointer-events: none; 
  opacity: 0; 
}
#screenshot-container .modal-content { 
  position: static; 
  max-height: none; 
  overflow: visible; 
  transform: none; 
  margin: 0; 
  box-shadow: none; 
  background: white; 
  padding: 32px; 
}
#screenshot-container .modal-header-fixed { display: none; }
#screenshot-container #m-img-container { margin: 0 0 24px 0; }
#screenshot-container .stat-bar-fill { 
  width: var(--width, 0%) !important; 
  transition: none !important; 
}
</style>
</head>
<body>
<a href="#main" class="skip-link">Перейти к содержимому</a>

<div id="preloader" role="status" aria-label="Загрузка">
  <div class="preloader-content">
    <div class="preloader-logo">BOX<span class="logo-accent">1</span>V1</div>
    <div class="loading-bar" aria-hidden="true"></div>
  </div>
</div>

<div id="toast-container" role="region" aria-live="polite" aria-atomic="true"></div>
<div id="search-live-region" class="live-region" role="status" aria-live="polite" aria-atomic="true"></div>

<nav id="navbar" role="navigation" aria-label="Главное меню">
  <div class="nav-inner">
    <a href="#home" class="logo" onclick="switchTab('home'); return false;" aria-label="BOX1V1 - На главную">
      BOX<span class="logo-accent">1</span>V1
    </a>
    <div class="nav-links">
      <a href="#home" onclick="switchTab('home'); return false;" id="btn-home" class="active" aria-current="page">Главная</a>
      <a href="#roster" onclick="switchTab('roster'); return false;" id="btn-roster">Участники</a>
      <a href="#stats" onclick="switchTab('stats'); return false;" id="btn-stats">Рейтинг</a>
    </div>
    <button class="burger" id="burger" onclick="toggleMenu()" aria-label="Открыть меню" aria-expanded="false" aria-controls="mobile-drawer">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </button>
  </div>
</nav>

<div class="drawer-overlay" id="drawer-overlay" onclick="toggleMenu()" aria-hidden="true"></div>
<div class="mobile-drawer" id="mobile-drawer" role="dialog" aria-label="Мобильное меню" aria-modal="true">
  <a href="#home" onclick="handleMobileNav('home'); return false;">Главная</a>
  <a href="#roster" onclick="handleMobileNav('roster'); return false;">Участники</a>
  <a href="#stats" onclick="handleMobileNav('stats'); return false;">Рейтинг</a>
  <div class="btn-group">
    <button class="btn" onclick="handleMobileNav('applyModal', true)" style="width:100%">Подать заявку</button>
  </div>
</div>

<main id="main" class="main-content">
  <section id="home" class="active" aria-label="Главная">
    <div class="intro-block">
      <span>The Next Gen Football</span>
      <h1>BOX1V1.</h1>
      <p>Решает не команда.<br>Решаешь ты.</p>
      <div class="btn-group">
        <button class="btn" onclick="switchTab('roster')">Участники</button>
        <button class="btn btn-outline" onclick="openModal('applyModal')">Подать заявку</button>
      </div>
      <div class="timer-context" id="timer-container">
        <span class="timer-label" id="timer-status">До старта сезона:</span>
        <div class="countdown" id="timer">
          <div><div class="countdown-value" id="days">00</div><div class="countdown-label">дн</div></div>
          <div><div class="countdown-value" id="hours">00</div><div class="countdown-label">чс</div></div>
          <div><div class="countdown-value" id="mins">00</div><div class="countdown-label">мин</div></div>
          <div><div class="countdown-value" id="secs">00</div><div class="countdown-label">сек</div></div>
        </div>
      </div>
    </div>
    <div class="bento-grid">
      <div class="card span-2" onclick="openModal('rulesModal')" tabindex="0" role="button" aria-label="Открыть регламент">
        <span style="font-size:11px; font-weight:700; color:var(--accent); text-transform:uppercase; letter-spacing:0.1em;">Документация</span>
        <h2>РЕГЛАМЕНТ.</h2>
        <p>Свод правил проведения матчей.</p>
        <div style="margin-top:auto; padding-top:20px; font-weight:700; font-size:12px; text-transform:uppercase; color:var(--text-secondary);">Изучить правила →</div>
      </div>
      <div class="card" onclick="window.open('https://t.me/streetbox1v1', '_blank')" tabindex="0" role="link" aria-label="Открыть Telegram">
        <h3>TELEGRAM</h3>
        <p>Свежие новости и актуальная информация.</p>
      </div>
      <div class="card" onclick="window.open('https://instagram.com/box.1v1', '_blank')" tabindex="0" role="link" aria-label="Открыть Instagram">
        <h3>INSTAGRAM</h3>
        <p>Главные новости в медиа формате.</p>
      </div>
    </div>
  </section>

  <section id="roster" aria-label="Участники">
    <div style="margin-bottom: 32px;">
      <h1 style="font-size: clamp(2rem, 10vw, 6rem);">УЧАСТНИКИ.</h1>
      <p style="font-size: 1.125rem; margin-top:8px; color: var(--text-secondary);">Действующие участники BOX1V1.</p>
    </div>
    <div class="controls-row">
      <input type="search" class="search-input" id="playerSearch" placeholder="Поиск по имени..." oninput="debouncedRender()" aria-label="Поиск игрока" autocomplete="off">
      <div class="filter-bar" role="group" aria-label="Фильтр по роли">
        <button class="filter-btn active" onclick="setRoleFilter('Все', this)" aria-pressed="true">Все</button>
        <button class="filter-btn" onclick="setRoleFilter('Игрок', this)" aria-pressed="false">Полевые</button>
        <button class="filter-btn" onclick="setRoleFilter('Вратарь', this)" aria-pressed="false">Вратари</button>
      </div>
    </div>
    <div class="bento-grid" id="roster-grid" role="region" aria-live="polite" aria-label="Сетка игроков"></div>
  </section>

  <section id="stats" aria-label="Рейтинг">
    <h1 style="font-size: clamp(2rem, 10vw, 6rem); margin-bottom:32px;">РЕЙТИНГ.</h1>
    <div class="table-wrapper" role="region" aria-label="Таблица рейтинга" tabindex="0">
      <table role="table" aria-label="Рейтинг игроков">
        <thead>
          <tr>
            <th scope="col" aria-label="Позиция">#</th>
            <th scope="col">Игрок</th>
            <th scope="col" style="text-align:right;">OVR</th>
          </tr>
        </thead>
        <tbody id="stats-body"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Player Modal -->
<div class="modal-overlay" id="playerModal" role="dialog" aria-modal="true" aria-labelledby="m-name" onclick="if(event.target === this) closeModal('playerModal')">
  <div class="modal-content" id="stats-card" onclick="event.stopPropagation()" role="document">
    <div class="modal-header-fixed">
      <button id="download-card" class="download-circle" aria-label="Скачать карточку игрока">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </button>
      <button class="modal-close" onclick="closeModal('playerModal')" aria-label="Закрыть карточку игрока">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div id="m-img-container">
      <img id="m-img" src="" alt="Фото игрока" crossorigin="anonymous" onload="this.classList.add('loaded')">
    </div>
    
    <div class="modal-header">
      <div class="modal-title-group">
        <span id="m-role">ROLE</span>
        <h2 id="m-name">NAME</h2>
        <div id="m-badges" role="list" aria-label="Бейджи игрока"></div>
      </div>
      <div id="m-ovr" aria-label="Общий рейтинг">99</div>
    </div>
    
    <div id="m-stats" role="region" aria-label="Характеристики игрока"></div>
    
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <button class="btn" style="flex:1; min-width:120px;" onclick="copyPlayerID()">Копировать ID</button>
      <button class="btn btn-outline" style="flex:1; min-width:120px;" onclick="sharePlayer()">Поделиться</button>
    </div>
  </div>
</div>

<!-- Apply Modal -->
<div class="modal-overlay" id="applyModal" role="dialog" aria-modal="true" aria-labelledby="apply-title" onclick="if(event.target === this) closeModal('applyModal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header-fixed">
      <button class="modal-close" onclick="closeModal('applyModal')" aria-label="Закрыть">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <h2 id="apply-title" style="font-size:1.5rem; margin:40px 0 16px; line-height:1.2;">ВСТУПИТЬ В BOX1V1</h2>
    <p style="margin-bottom:24px; color:var(--text-secondary); line-height:1.6; font-size: 0.95rem;">Чтобы оформить заявку, оставь комментарий под любым постом с хештегом <strong style="color:var(--text);">#BOXУЧАСТВОВАТЬ</strong>.</p>
    <button class="btn" style="width:100%;" onclick="window.open('https://t.me/streetbox1v1', '_blank')">Открыть Telegram</button>
  </div>
</div>

<!-- Rules Modal -->
<div class="modal-overlay" id="rulesModal" role="dialog" aria-modal="true" aria-labelledby="rules-title" onclick="if(event.target === this) closeModal('rulesModal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header-fixed">
      <button class="modal-close" onclick="closeModal('rulesModal')" aria-label="Закрыть">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <h2 id="rules-title" style="font-size:1.5rem; margin:40px 0 24px; line-height:1.2;">РЕГЛАМЕНТ</h2>
    <div style="display:flex; flex-direction:column; gap:20px;">
      <article style="padding-bottom:20px; border-bottom:1px solid var(--border);">
        <h3 style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--accent); margin-bottom:6px; letter-spacing:0.1em;">01. Формат</h3>
        <p style="color:var(--text-secondary); line-height:1.6; margin:0; font-size: 0.95rem;">Матчи 1 на 1 с участием независимого вратаря.</p>
      </article>
      <article style="padding-bottom:20px; border-bottom:1px solid var(--border);">
        <h3 style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--accent); margin-bottom:6px; letter-spacing:0.1em;">02. Тайминг</h3>
        <p style="color:var(--text-secondary); line-height:1.6; margin:0; font-size: 0.95rem;">Лимит на атаку — 20 секунд.</p>
      </article>
      <article>
        <h3 style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--accent); margin-bottom:6px; letter-spacing:0.1em;">03. Результат</h3>
        <p style="color:var(--text-secondary); line-height:1.6; margin:0; font-size: 0.95rem;">Продолжительность игры до двух голов, без ничьи.</p>
      </article>
    </div>
  </div>
</div>

<!-- Скрытый контейнер для скриншотов -->
<div id="screenshot-container" aria-hidden="true"></div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREjbeB6jNrU01kw1npVtFTvqGdP134ERjmyROoOYeYXbzjgL0ZCNK6KwF0VTk3c1yxZEZEUsJjy2Ur/pub?output=csv';
const TARGET_DATE = new Date("March 1, 2026 00:00:00").getTime();

let allPlayers = [];
let currentRoleFilter = 'Все';
let renderTimeout;
let lastFocusedElement = null;
let statAnimationTimers = [];
let focusTrapHandler = null;

const statDefs = {
  'DRI': 'Техника контроля мяча и ведения дриблинга',
  'SPD': 'Стартовый рывок и скорость перемещения',
  'SHT': 'Мощность и точность завершающего удара',
  'PHY': 'Физическая мощь, борьба и атлетизм',
  'REF': 'Молниеносная реакция на удары в упор',
  'DIV': 'Дальность прыжка и охват створа ворот',
  'HAN': 'Надежность фиксации и отражения мяча',
  'POS': 'Грамотный выбор позиции в створе ворот'
};

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

function showToast(message, duration = 3000) {
  const container = $('#toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.setAttribute('role', 'status');
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    setTimeout(() => toast.remove(), 500);
  }, duration);
}

function announceToScreenReader(message) {
  const region = $('#search-live-region');
  region.textContent = message;
  setTimeout(() => { region.textContent = ''; }, 1000);
}

function parseCSV(text) {
  const lines = text.replace(/\r/g, '').split('\n').filter(r => r.trim());
  if (lines.length < 2) return [];
  
  const result = [];
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i];
    const cells = [];
    let cell = '';
    let inQuotes = false;
    
    for (let j = 0; j < row.length; j++) {
      const char = row[j];
      const nextChar = row[j + 1];
      
      if (char === '"') {
        if (inQuotes && nextChar === '"') {
          cell += '"';
          j++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        cells.push(cell.trim());
        cell = '';
      } else {
        cell += char;
      }
    }
    cells.push(cell.trim());
    
    if (cells[0]) {
      result.push({
        name: cells[0] || '',
        ovr: parseInt(cells[1]) || 0,
        role: cells[2] || 'Игрок',
        drib: parseInt(cells[3]) || 0,
        speed: parseInt(cells[4]) || 0,
        shot: parseInt(cells[5]) || 0,
        phys: parseInt(cells[6]) || 0,
        photo: cells[7] || '',
        status: cells[8] || '',
        badges: cells[9] ? cells[9].split('|').map(b => b.trim()).filter(Boolean) : []
      });
    }
  }
  return result;
}

async function init() {
  try {
    const response = await fetch(CSV_URL);
    if (!response.ok) throw new Error('Network error');
    const text = await response.text();
    allPlayers = parseCSV(text);
    
    if (allPlayers.length === 0) {
      showToast('Ростер временно пуст');
    } else {
      renderRoster();
      renderStats();
    }
    
    handleHashAndDeepLink();
    updateTimer();
    setInterval(updateTimer, 1000);
    setupDownloadButton();
    setupScrollDetection();
    
    setTimeout(() => $('#preloader').classList.add('loaded'), 500);
  } catch (error) {
    console.error('Init error:', error);
    showToast('Ошибка загрузки данных');
    $('#preloader').classList.add('loaded');
  }
}

function handleHashAndDeepLink() {
  const hash = window.location.hash;
  if (!hash) return;
  const [hashPart, queryPart] = hash.split('?');
  const cleanHash = hashPart.replace('#', '');
  if (['home', 'roster', 'stats'].includes(cleanHash)) {
    switchTab(cleanHash, false);
  }
  if (queryPart) {
    const params = new URLSearchParams(queryPart);
    const playerName = params.get('player');
    if (playerName) {
      const name = playerName.replace(/-/g, ' ');
      const player = allPlayers.find(p => p.name.toLowerCase() === name.toLowerCase());
      if (player) setTimeout(() => openPlayerModal(player.name), 300);
    }
  }
}

function switchTab(id, updateHash = true) {
  const target = $(`#${id}`);
  if (!target) return;
  $$('section').forEach(s => {
    s.classList.remove('active');
    s.setAttribute('aria-hidden', 'true');
  });
  $$('.nav-links a').forEach(a => {
    a.classList.remove('active');
    a.removeAttribute('aria-current');
  });
  target.classList.add('active');
  target.removeAttribute('aria-hidden');
  const btn = $(`#btn-${id}`);
  if (btn) {
    btn.classList.add('active');
    btn.setAttribute('aria-current', 'page');
  }
  if (updateHash) {
    const currentHash = window.location.hash;
    const [path] = currentHash.split('?');
    window.history.pushState(null, null, `#${id}`);
  }
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ИСПРАВЛЕННЫЙ РЕНДЕР КАРТОЧЕК */
function renderRoster() {
  const grid = $('#roster-grid');
  const search = $('#playerSearch').value.toLowerCase().trim();
  const filtered = allPlayers.filter(p => {
    const matchesSearch = p.name.toLowerCase().includes(search);
    const matchesRole = currentRoleFilter === 'Все' || p.role === currentRoleFilter;
    return matchesSearch && matchesRole;
  });
  
  announceToScreenReader(`Найдено игроков: ${filtered.length}`);
  
  if (filtered.length === 0) {
    grid.innerHTML = `<div style="grid-column: 1/-1; padding: 60px 20px; text-align: center; color: var(--text-secondary);"><p style="font-size: 1.125rem;">Атлеты не найдены</p><p style="font-size: 0.875rem; margin-top: 8px;">Попробуйте изменить параметры поиска</p></div>`;
    return;
  }
  
  // Генерируем карточки с уникальными ID для изображений
  grid.innerHTML = filtered.map((p, i) => {
    const playerId = p.name.replace(/\s+/g, '-').replace(/[^a-zA-Zа-яА-Я0-9-]/g, '');
    const photoUrl = p.photo && p.photo.startsWith('http') ? p.photo : 'https://via.placeholder.com/400x600/333/fff?text=No+Photo';
    
    return `
    <div class="card player-card" tabindex="0" role="button" aria-label="Карточка игрока ${p.name}, рейтинг ${p.ovr}"
         style="animation: fadeIn 0.5s ${i * 0.05}s forwards; opacity: 0;"
         onclick="openPlayerModal('${p.name.replace(/'/g, "\\'")}')"
         onkeydown="handlePlayerCardKeydown(event, '${p.name.replace(/'/g, "\\'")}')">
      
      <div class="player-img" id="img-${playerId}" 
           data-src="${photoUrl}"
           style="background-image: url('${photoUrl}');"
           aria-hidden="true"></div>
      
      ${p.status ? `<div class="status-badge">${p.status}</div>` : ''}
      
      <div class="player-info">
        <span>${p.role}</span>
        <h3>${escapeHtml(p.name)}</h3>
        ${p.badges.length > 0 ? `<div class="player-badges">${escapeHtml(p.badges[0])}</div>` : ''}
        <span class="ovr-badge">OVR ${p.ovr}</span>
      </div>
    </div>
  `}).join('');
  
  // Проверяем загрузку изображений после рендера
  setTimeout(() => {
    filtered.forEach(p => {
      const playerId = p.name.replace(/\s+/g, '-').replace(/[^a-zA-Zа-яА-Я0-9-]/g, '');
      const imgDiv = document.getElementById(`img-${playerId}`);
      if (imgDiv) {
        const img = new Image();
        img.onload = () => imgDiv.classList.add('loaded');
        img.onerror = () => {
          imgDiv.classList.add('error');
          imgDiv.style.backgroundImage = 'none';
        };
        img.src = imgDiv.getAttribute('data-src');
      }
    });
  }, 100);
}

function handlePlayerCardKeydown(event, name) {
  if (event.key === 'Enter' || event.key === ' ') {
    event.preventDefault();
    openPlayerModal(name);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderStats() {
  const sorted = [...allPlayers].sort((a, b) => b.ovr - a.ovr);
  $('#stats-body').innerHTML = sorted.map((p, i) => `
    <tr onclick="openPlayerModal('${p.name.replace(/'/g, "\\'")}')" tabindex="0" role="button" aria-label="${i + 1} место, ${p.name}, ${p.role}, рейтинг ${p.ovr}"
        onkeydown="if(event.key === 'Enter') openPlayerModal('${p.name.replace(/'/g, "\\'")}')"
        style="animation: fadeIn 0.3s ${i * 0.03}s forwards; opacity: 0;">
      <td style="font-weight:700; color:var(--text-tertiary); font-variant-numeric: tabular-nums;">${(i + 1).toString().padStart(2, '0')}</td>
      <td>
        <div class="player-row">
          <img src="${p.photo || 'https://via.placeholder.com/100'}" alt="" class="player-avatar-sm" loading="lazy" onerror="this.src='https://via.placeholder.com/100/333/fff?text=?'" crossorigin="anonymous">
          <div class="player-info-sm">
            <div class="player-name-sm">${escapeHtml(p.name)}</div>
            <div class="player-role-sm">${p.role}</div>
          </div>
        </div>
      </td>
      <td style="text-align:right;"><span class="ovr-badge" style="margin:0;">${p.ovr}</span></td>
    </tr>
  `).join('');
}

function openPlayerModal(name) {
  statAnimationTimers.forEach(clearTimeout);
  statAnimationTimers = [];
  
  const p = allPlayers.find(x => x.name.toLowerCase() === name.toLowerCase());
  if (!p) { showToast('Игрок не найден'); return; }
  
  lastFocusedElement = document.activeElement;
  $('#m-name').textContent = p.name;
  $('#m-role').textContent = p.role;
  $('#m-ovr').textContent = p.ovr;
  
  const imgEl = $('#m-img');
  imgEl.classList.remove('loaded');
  imgEl.style.display = 'block';
  
  // Используем прокси для CORS если нужно
  const proxiedUrl = p.photo && p.photo.startsWith('http') && !p.photo.includes('localhost') 
    ? `https://images.weserv.nl/?url=${encodeURIComponent(p.photo)}&default=${encodeURIComponent(p.photo)}`
    : p.photo || 'https://via.placeholder.com/400x600';
  
  imgEl.src = proxiedUrl;
  
  $('#m-badges').innerHTML = p.badges.map(b => `<span class="badge" role="listitem">${escapeHtml(b)}</span>`).join('') || '';
  
  const isGK = p.role === 'Вратарь';
  const stats = [
    { key: isGK ? 'REF' : 'DRI', value: p.drib },
    { key: isGK ? 'DIV' : 'SPD', value: p.speed },
    { key: isGK ? 'HAN' : 'SHT', value: p.shot },
    { key: isGK ? 'POS' : 'PHY', value: p.phys }
  ];
  
  $('#m-stats').innerHTML = stats.map(s => `
    <div class="stat-item">
      <div class="stat-header">
        <div class="stat-label-group" data-tooltip="${statDefs[s.key]}" tabindex="0" role="tooltip" aria-label="${statDefs[s.key]}">
          <span class="stat-label">${s.key}</span>
          <i class="info-icon" aria-hidden="true">?</i>
        </div>
        <span class="stat-value">${s.value}</span>
      </div>
      <div class="stat-bar-bg" aria-hidden="true">
        <div class="stat-bar-fill ${s.value >= 90 ? 'accent' : ''}" id="bar-${s.key}" style="width: 0%" data-width="${s.value}%"></div>
      </div>
    </div>
  `).join('');
  
  openModal('playerModal');
  
  stats.forEach((s, index) => {
    const timer = setTimeout(() => {
      const bar = $(`#bar-${s.key}`);
      if (bar) bar.style.width = bar.getAttribute('data-width');
    }, 100 + (index * 50));
    statAnimationTimers.push(timer);
  });
  
  const currentTab = $('section.active')?.id || 'home';
  const slug = p.name.replace(/\s+/g, '-').toLowerCase();
  window.history.replaceState(null, null, `#${currentTab}?player=${slug}`);
}

function openModal(id) {
  const modal = $(`#${id}`);
  if (!modal) return;
  
  cleanupModalHandlers();
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  // Focus trap
  const content = modal.querySelector('.modal-content');
  if (content) {
    focusTrapHandler = createFocusTrap(content);
    document.addEventListener('keydown', focusTrapHandler);
  }
  
  setTimeout(() => {
    const focusable = modal.querySelector('button, [href], input, [tabindex]:not([tabindex="-1"])');
    if (focusable) focusable.focus();
  }, 100);
}

function cleanupModalHandlers() {
  if (focusTrapHandler) {
    document.removeEventListener('keydown', focusTrapHandler);
    focusTrapHandler = null;
  }
}

function createFocusTrap(element) {
  const focusableElements = element.querySelectorAll('button, [href], input, select, [tabindex]:not([tabindex="-1"])');
  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];
  
  return function(e) {
    if (e.key !== 'Tab') return;
    
    if (e.shiftKey) {
      if (document.activeElement === firstFocusable) {
        lastFocusable.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === lastFocusable) {
        firstFocusable.focus();
        e.preventDefault();
      }
    }
  };
}

function closeModal(id) {
  const modal = $(`#${id}`);
  if (!modal) return;
  
  statAnimationTimers.forEach(clearTimeout);
  statAnimationTimers = [];
  
  cleanupModalHandlers();
  
  modal.classList.remove('active');
  document.body.style.overflow = '';
  
  if (lastFocusedElement) { 
    lastFocusedElement.focus(); 
    lastFocusedElement = null; 
  }
  
  if (id === 'playerModal') {
    const currentTab = $('section.active')?.id || 'home';
    window.history.replaceState(null, null, `#${currentTab}`);
  }
}

function setRoleFilter(role, btn) {
  currentRoleFilter = role;
  $$('.filter-btn').forEach(b => { 
    b.classList.remove('active'); 
    b.setAttribute('aria-pressed', 'false'); 
  });
  btn.classList.add('active');
  btn.setAttribute('aria-pressed', 'true');
  renderRoster();
}

function debouncedRender() {
  clearTimeout(renderTimeout);
  renderTimeout = setTimeout(renderRoster, 150);
}

function toggleMenu() {
  const drawer = $('#mobile-drawer');
  const overlay = $('#drawer-overlay');
  const burger = $('#burger');
  const isOpen = drawer.classList.toggle('open');
  overlay.classList.toggle('open');
  burger.classList.toggle('open');
  burger.setAttribute('aria-expanded', isOpen);
  if (isOpen) {
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
    if (lastFocusedElement) lastFocusedElement.focus();
  }
}

function handleMobileNav(id, isModal = false) {
  toggleMenu();
  setTimeout(() => isModal ? openModal(id) : switchTab(id), 300);
}

async function copyPlayerID() {
  const name = $('#m-name').textContent;
  try {
    await navigator.clipboard.writeText(name);
    showToast('ID скопирован');
  } catch { 
    showToast('Не удалось скопировать'); 
  }
}

async function sharePlayer() {
  const name = $('#m-name').textContent;
  const url = window.location.href;
  
  const shareData = { 
    title: `BOX1V1 | ${name}`, 
    text: `Карточка атлета ${name} в системе BOX1V1`, 
    url: url 
  };
  
  if (navigator.share) {
    try {
      await navigator.share(shareData);
    } catch (err) { 
      if (err.name !== 'AbortError') showToast('Ошибка при отправке');
    }
  } else {
    try {
      await navigator.clipboard.writeText(url);
      showToast('Ссылка скопирована');
    } catch { 
      showToast('Не удалось скопировать ссылку'); 
    }
  }
}

function setupDownloadButton() {
  const btn = $('#download-card');
  if (!btn || btn.dataset.initialized) return;
  btn.dataset.initialized = 'true';
  
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    btn.style.opacity = '0.5';
    btn.disabled = true;
    btn.style.transform = 'scale(0.95)';
    showToast('Создаём карточку...', 3000);
    
    try {
      const img = $('#m-img');
      if (!img.complete) {
        await new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve;
          setTimeout(resolve, 3000);
        });
      }
      
      const container = $('#screenshot-container');
      container.innerHTML = '';
      
      const original = $('#stats-card');
      const clone = original.cloneNode(true);
      
      clone.querySelector('.modal-header-fixed')?.remove();
      
      clone.style.cssText = `
        position: static; 
        max-height: none; 
        overflow: visible; 
        transform: none; 
        width: 480px; 
        background: white; 
        padding: 32px; 
        border-radius: 24px; 
        box-shadow: none;
        border: 1px solid #eee;
      `;
      
      const cloneImg = clone.querySelector('#m-img');
      if (img.complete && img.naturalWidth > 0) {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          cloneImg.src = canvas.toDataURL('image/png');
          cloneImg.style.opacity = '1';
        } catch (e) {
          console.log('CORS error, using original src');
        }
      }
      
      clone.querySelectorAll('.stat-bar-fill').forEach(bar => {
        bar.style.width = bar.getAttribute('data-width');
        bar.style.transition = 'none';
      });
      
      container.appendChild(clone);
      await new Promise(resolve => setTimeout(resolve, 200));
      
      const canvas = await html2canvas(clone, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: 480,
        height: clone.offsetHeight,
        logging: false
      });
      
      container.innerHTML = '';
      
      const playerName = $('#m-name')?.textContent || 'player';
      const safeName = playerName.replace(/[^a-zA-Zа-яА-Я0-9]/g, '_');
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
      
      if (!blob) throw new Error('Canvas to Blob failed');
      
      const file = new File([blob], `BOX1V1_${safeName}.png`, { type: 'image/png' });
      
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: `BOX1V1 ${playerName}`, text: 'Карточка игрока' });
          showToast('Готово!');
          resetBtn();
          return;
        } catch (err) {
          if (err.name === 'AbortError') { resetBtn(); return; }
        }
      }
      
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `BOX1V1_${safeName}.png`;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
      
      showToast('Карточка сохранена!');
    } catch (error) {
      console.error('Download error:', error);
      showToast('Ошибка при создании карточки');
    } finally {
      resetBtn();
    }
    
    function resetBtn() {
      btn.style.opacity = '';
      btn.disabled = false;
      btn.style.transform = '';
    }
  });
}

function updateTimer() {
  const now = Date.now();
  const diff = TARGET_DATE - now;
  
  if (diff <= 0) {
    $('#timer-status').textContent = 'Сезон открыт!';
    $('#timer').style.display = 'none';
    return;
  }
  
  const days = Math.floor(diff / 86400000);
  const hours = Math.floor((diff % 86400000) / 3600000);
  const mins = Math.floor((diff % 3600000) / 60000);
  const secs = Math.floor((diff % 60000) / 1000);
  
  $('#days').textContent = days.toString().padStart(2, '0');
  $('#hours').textContent = hours.toString().padStart(2, '0');
  $('#mins').textContent = mins.toString().padStart(2, '0');
  $('#secs').textContent = secs.toString().padStart(2, '0');
}

function setupScrollDetection() {
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        $('#navbar').classList.toggle('scrolled', window.scrollY > 50);
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });
}

// Escape для закрытия модалок
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal('playerModal');
    closeModal('applyModal');
    closeModal('rulesModal');
  }
});

window.addEventListener('DOMContentLoaded', init);
window.addEventListener('hashchange', handleHashAndDeepLink);
</script>
</body>
</html>
